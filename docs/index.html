<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Explore costs | Lambert Smith Hampton</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind CSS for quick layout -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <!-- DIN Pro font -->
  <link href="https://fonts.cdnfonts.com/css/dinpro" rel="stylesheet" />
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <style>
    :root { --lsh-red:#cc2030; --lsh-red-dark:#871720; }
    body { font-family:'DINPro','DIN Pro',Arial,sans-serif; font-feature-settings:'liga' 0; -webkit-font-feature-settings:'liga' 0; }
    h1,h2 { font-family:'DINPro','DIN Pro',Arial,sans-serif; }
    .font-din-bold{ font-family:'DINPro Bold','DINPro',Arial,sans-serif; font-weight:700; }
    .font-din-light{ font-family:'DINPro Light','DINPro',Arial,sans-serif; font-weight:300; }
    .font-din-regular{ font-family:'DINPro','DIN Pro',Arial,sans-serif; font-weight:400; }
    .text-lsh-red{ color:var(--lsh-red); }
    .bg-lsh-red{ background-color:var(--lsh-red); }
    .hover\:bg-lsh-red-dark:hover{ background-color:#b51c2a; }
    #map{ width:100%; height:420px; }
    .region-btn{ background:#e5e7eb; padding:0.25rem 0.5rem; border-radius:0.25rem; font-size:0.875rem; cursor:pointer; }
    .region-btn:hover{ background:#d1d5db; }
    .region-btn.active{ background:var(--lsh-red); color:#fff; }
    .select-btn{ background:#e5e7eb; padding:0.25rem 0.5rem; border-radius:0.25rem; font-size:0.875rem; cursor:pointer; }
    .select-btn:hover{ background:#d1d5db; }
    .select-btn.active{ background:var(--lsh-red); color:#fff; }
    .error{ border-color:#dc2626!important; }
    .err-msg{ display:none; color:#dc2626; font-size:0.75rem; }
    /* result label (smaller, lighter) */
    .result-label{
      font-size:0.875rem;          /* text-sm */
      font-weight:500;             /* medium */
      color:#4b5563;               /* gray-700 */
      display:block;
      line-height:1.2;
    }
    /* result value (larger, bolder) */
    .result-value{
      font-size:1.875rem;          /* text-3xl */
      font-weight:700;             /* bold */
      color:#111827;               /* gray-900 */
      display:block;
      line-height:1.2;
      white-space:nowrap;
    }
    .result-scroll{overflow-x:hidden;overflow-y:hidden;}
    .result-scroll.need-scroll{overflow-x:auto;}
    .result-title{white-space:nowrap;}
    #resultContainer.compare .result-value{font-size:1.5rem;}
    #resultContainer.single{text-align:left;grid-template-columns:1fr;}
    @media (min-width:768px){#resultContainer.single{grid-template-columns:1fr;}}
    #resultContainer.compare{text-align:center;}
    .tab-btn{padding:0.5rem 1rem;border-bottom:2px solid transparent;}
    .tab-btn.active{border-color:var(--lsh-red);color:var(--lsh-red);font-weight:700;}
    .occ-bar-new{background:var(--lsh-red);transition:height .3s ease,opacity .3s ease;}
    .occ-bar-old{background:#6b7280;transition:height .3s ease,opacity .3s ease;}
    .tooltip-name{color:var(--lsh-red);background:none;border-radius:0;padding:0;}
    .compare-popup .btn{padding:0.25rem 0.5rem;font-size:0.75rem;border-radius:0.25rem;}
    .compare-popup .btn-red{background:var(--lsh-red);color:#fff;}
    .compare-popup .btn-gray{background:#e5e7eb;color:#111827;}
    .remove-btn{position:absolute;top:0;right:0;padding:0 0.25rem;line-height:1;font-size:0.875rem;}
    .remove-btn:hover{color:var(--lsh-red);}
    .table-remove{position:sticky;right:0;top:0;z-index:10;}
    .occ-placeholder{border:2px dashed #cbd5e0;border-radius:0.25rem;width:4rem;height:4rem;display:flex;align-items:center;justify-content:center;font-size:1.5rem;color:#cbd5e0;}
    /* bar labels */
    .bar-label{line-height:1;text-align:center;}
    .bar-label small{font-size:0.65rem;}
    /* category labels under bars */
    .bar-cat{font-size:0.65rem;line-height:1;text-align:center;}
    /* table extra columns hidden until expanded */
    .extra-col{display:none;}
    #occTables.expanded .extra-col{display:table-cell;}
    /* tables scroll horizontally when expanded */
    #occTables{overflow-x:auto;}
    #occTables.expanded table{min-width:52rem;}
    #occTables th{white-space:nowrap;}
    /* allow occupancy bars to scroll horizontally */
    #occBars{overflow-x:auto;}
    #occBars .bar-col{flex:0 0 8rem;}
    button{transition:transform .1s ease;}
    button:active{transform:scale(.95);}
    .fade-in{animation:fadeIn .3s ease;}
    @keyframes fadeIn{from{opacity:0;transform:translateY(.5rem);}to{opacity:1;transform:translateY(0);}}
    /* Use a DIN-like system font for dropdowns to avoid Sheffield ligature issues */
    select,option{font-family:'Helvetica Neue',Arial,sans-serif;font-feature-settings:'liga' 0;-webkit-font-feature-settings:'liga' 0;}
  </style>
</head>
<body class="bg-gray-50 antialiased">
  <!-- Header -->
  <header class="bg-white shadow">
    <div class="max-w-6xl mx-auto px-4 py-6">
      <h1 class="text-4xl font-din-bold text-gray-900">Explore costs</h1>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-8 grid grid-cols-1 md:grid-cols-2 gap-6">

    <!-- Map -->
    <section class="bg-white p-6 rounded-lg shadow-md order-2 md:order-1" id="mapSection">
      <h2 class="text-2xl md:text-3xl font-din-bold mb-4 text-lsh-red">UK office locations</h2>
      <div id="regionToggle" class="flex flex-wrap gap-2 mb-4"></div>
      <div id="map" class="rounded"></div>
      <p class="mt-4 text-sm text-gray-500 font-din-light">Hover a marker to view rental rates; click to select. Use the buttons above to zoom to a region.</p>
    </section>

    <!-- Calculator / Occupancy -->
    <section class="bg-white p-6 rounded-lg shadow-md order-1 md:order-2" id="calcSection">
        <h2 class="text-2xl md:text-3xl font-din-bold mb-4 text-lsh-red">UK office cost calculator</h2>
      <div class="mb-4 flex gap-2">
        <button id="calcTab" class="tab-btn active">Space calculator</button>
        <button id="occTab" class="tab-btn">Occupancy costs</button>
      </div>
      <div id="calcWrapper">

        <label class="block text-lg font-din-bold text-gray-700 mb-1">Calculate based on</label>
        <div id="modeBtns" class="flex gap-2 mb-1">
          <button class="select-btn" data-value="people">Number of people → cost</button>
          <button class="select-btn" data-value="budget">Budget → capacity</button>
        </div>
        <p id="modeError" class="err-msg mb-3">Please select an option</p>

        <label class="block text-lg font-din-bold text-gray-700 mb-1">Building age</label>
        <div id="ageBtns" class="flex gap-2 mb-1">
          <button class="select-btn" data-value="New">New build</button>
          <button class="select-btn" data-value="20">20‑year old</button>
        </div>
        <p id="ageError" class="err-msg mb-3">Please select building age</p>

        <div class="md:flex gap-4">
          <div class="flex-1">
            <label for="locationSelect" class="block text-lg font-din-bold text-gray-700 mb-1">Location</label>
            <select id="locationSelect" class="w-full border rounded p-2 mb-1 bg-white">
              <option value="" disabled selected>Please select</option>
            </select>
            <p id="locationError" class="err-msg mb-3">Please select a location</p>
          </div>
        <div id="loc2Wrap" class="flex-1 hidden relative">
            <label for="locationSelect2" class="block text-lg font-din-bold text-gray-700 mb-1">Location 2</label>
            <button id="removeLoc2" class="remove-btn" style="display:none" aria-label="Remove location 2">&times;</button>
            <div>
              <select id="locationSelect2" class="w-full border rounded p-2 mb-1 bg-white pr-6">
                <option value="" disabled selected>Please select</option>
              </select>
            </div>
          </div>
        </div>
        <p id="comparePrompt" class="text-sm text-gray-500 mb-3 hidden">Select another location on the map to compare results.</p>

        <label for="typeSelect" class="block text-lg font-din-bold text-gray-700 mb-1">Workstation type</label>
        <select id="typeSelect" class="w-full border rounded p-2 mb-1 bg-white">
          <option value="" disabled selected>Please select</option>
          <option value="Average">Average workstation (no change)</option>
          <option value="Corporate">Corporate (+20% space per person)</option>
          <option value="Finance">Finance, insurance (-26% space per person)</option>
          <option value="Professional">Professional (+27% space per person)</option>
          <option value="Public">Public (-2% space per person)</option>
          <option value="Tech">Tech, media, telecomms (-13% space per person)</option>
        </select>
        <p id="typeError" class="err-msg mb-3">Please select workstation type</p>

        <!-- People input -->
        <div id="peopleGroup" class="mb-3 hidden">
          <label for="peopleInput" class="block text-lg font-din-bold text-gray-700 mb-1">How many people?</label>
          <input type="number" id="peopleInput" class="w-full border rounded p-2" placeholder="e.g. 25" />
          <p id="peopleError" class="err-msg mt-1">Enter a number &gt; 0</p>
        </div>

        <!-- Budget input -->
        <div id="budgetGroup" class="mb-3 hidden">
          <label for="budgetInput" class="block text-lg font-din-bold text-gray-700 mb-1">Annual budget (£)</label>
          <input type="text" id="budgetInput" inputmode="numeric" class="w-full border rounded p-2" placeholder="e.g. 750,000" />
          <p id="budgetError" class="err-msg mt-1">Enter a budget &gt; 0</p>
        </div>

        <div id="calcBtnWrap" class="flex items-center gap-2 mt-2">
          <button id="calcBtn" class="bg-lsh-red hover:bg-lsh-red-dark text-white px-4 py-2 rounded font-din-bold flex-1">Calculate</button>
          <button id="calcClear" class="bg-gray-200 hover:bg-gray-300 text-sm px-3 py-2 rounded font-din-bold">Clear</button>
        </div>

        <div id="resultWrapper" class="mt-6 hidden">
          <div id="resultContainer" class="grid md:grid-cols-2 gap-4">
            <div id="resultBox1" class="space-y-3">
              <h3 id="resultTitle1" class="font-din-bold text-xl result-scroll result-title"></h3>
              <div id="areaResult1" class="result-scroll"></div>
              <div id="costResult1" class="result-scroll"></div>
              <div id="peopleResult1" class="result-scroll"></div>
            </div>
            <div id="resultBox2" class="space-y-3 md:border-l md:pl-4 hidden">
              <h3 id="resultTitle2" class="font-din-bold text-xl result-scroll result-title"></h3>
              <div id="areaResult2" class="result-scroll"></div>
              <div id="costResult2" class="result-scroll"></div>
              <div id="peopleResult2" class="result-scroll"></div>
            </div>
          </div>
        </div>

        <div id="calcDownloadWrap" class="flex justify-end mt-2 hidden">
          <div class="relative">
            <button id="calcDownloadBtn" class="p-1" aria-label="Download">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a1 1 0 001 1h14a1 1 0 001-1v-1m-5-4l-3 3m0 0l-3-3m3 3V4" />
              </svg>
            </button>
            <div id="calcDownloadMenu" class="absolute right-0 mt-2 bg-white border rounded shadow text-sm p-2 space-y-1 hidden">
              <button id="calcDownloadCsv" class="block w-full text-left">CSV</button>
            </div>
          </div>
        </div>

        <p class="mt-6 text-xs text-gray-500 leading-snug font-din-light">*Calculations use LSH cost data and assume <strong>12.5&nbsp;m² per average workstation</strong>.</p>
      </div>

      <div id="occPrompt" class="mb-4 text-center text-gray-500">
        <div class="flex justify-center gap-4 mb-4">
          <div class="occ-placeholder">+</div>
          <div class="occ-placeholder">+</div>
          <div class="occ-placeholder">+</div>
        </div>
        <button id="occAddBtn" class="bg-lsh-red hover:bg-lsh-red-dark text-white px-4 py-2 rounded font-din-bold mb-2">Add location</button>
        <div id="occAddSelectWrap" class="mt-2 hidden">
          <select id="occAddSelect" class="border rounded p-2 bg-white">
            <option value="" disabled selected>Please select</option>
          </select>
        </div>
      </div>
      <div id="occWrapper" class="hidden">
        <div class="flex justify-between items-center mb-4 relative">
          <button id="occClear" class="bg-gray-200 hover:bg-gray-300 text-sm px-3 py-1 rounded font-din-bold">Clear</button>
          <div class="relative">
            <button id="occFilterBtn" class="p-1" aria-label="Filter">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2a1 1 0 01-.293.707L15 12.414V19a1 1 0 01-.553.894l-4 2A1 1 0 019 21v-8.586L3.293 6.707A1 1 0 013 6V4z" />
              </svg>
            </button>
            <div id="occFilterMenu" class="absolute right-0 mt-2 bg-white border rounded shadow text-sm p-2 space-y-1 hidden">
              <label class="flex items-center gap-1 whitespace-nowrap"><input type="checkbox" id="filterNew" checked> New build</label>
              <label class="flex items-center gap-1 whitespace-nowrap"><input type="checkbox" id="filterOld" checked> 20‑yr old</label>
            </div>
          </div>
        </div>
        <div id="occBars" class="flex gap-4 items-end mb-4 w-full"></div>
        <div id="occExpandWrap" class="flex justify-end mb-2">
          <button id="occExpand" class="bg-gray-200 hover:bg-gray-300 text-sm px-3 py-1 rounded font-din-bold">Expand</button>
        </div>
        <p id="occLimitMsg" class="hidden text-xs text-lsh-red mb-2">You can compare up to 3 locations.</p>
        <div id="occTables"></div>
        <div id="occDownloadWrap" class="flex justify-end mt-2 hidden">
          <div class="relative">
            <button id="downloadBtn" class="p-1" aria-label="Download">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a1 1 0 001 1h14a1 1 0 001-1v-1m-5-4l-3 3m0 0l-3-3m3 3V4" />
              </svg>
            </button>
            <div id="downloadMenu" class="absolute right-0 mt-2 bg-white border rounded shadow text-sm p-2 space-y-1 hidden">
              <button id="downloadCsv" class="block w-full text-left">CSV</button>
            </div>
          </div>
        </div>
        <p class="text-xs text-gray-500" id="occUnits">All costs are per sq ft.</p>
      </div>
    </section>
  </main>

  <footer class="text-center text-sm text-gray-400 py-6 font-din-light">© Lambert Smith Hampton — Prototype tool for illustration only.</footer>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="costs.js"></script>
  <script>
    if(typeof L==='undefined'){console.error('Leaflet failed to load.');}
    (function(){
      const AGE_MAP={ '20':'old', New:'new' };
      const TYPE_SPACE={ Average:1, Corporate:1.2, Finance:0.74, Professional:1.27, Public:0.98, Tech:0.87 };
      const LOCS=[
        {name:'Edinburgh',coords:[55.9533,-3.1883],region:'Scotland',main:true},
        {name:'Birmingham',coords:[52.4862,-1.8904],region:'West Midlands'},
        {name:'Bristol',coords:[51.4545,-2.5879],region:'South West',main:true},
        {name:'Liverpool',coords:[53.4084,-2.9916],region:'North West',main:true},
        {name:'Manchester',coords:[53.4808,-2.2426],region:'North West',main:true},
        {name:'Leeds',coords:[53.7997,-1.5492],region:'Yorkshire & Humber',main:true},
        {name:'London',coords:[51.5072,-0.1276],region:'London',main:true,regionMarker:true},
        {name:'Reading',coords:[51.4543,-0.9781],region:'South East'},
        {name:'London - City',coords:[51.5155,-0.0922],region:'London'},
        {name:'London - Docklands',coords:[51.502348,-0.017652],region:'London'},
        {name:'London - Hammersmith',coords:[51.492,-0.223],region:'London'},
        {name:'London - Midtown',coords:[51.517,-0.12],region:'London'},
        {name:'London - Southbank',coords:[51.5067,-0.0995],region:'London'},
        {name:'London - West End Core',coords:[51.512,-0.129],region:'London'},
        {name:'London - West End Non Core',coords:[51.517,-0.143],region:'London'},
        {name:'Aberdeen',coords:[57.1497,-2.0943],region:'Scotland'},
        {name:'Basingstoke',coords:[51.2667,-1.0879],region:'South East'},
        {name:'Belfast',coords:[54.597,-5.93],region:'Northern Ireland',main:true},
        {name:'Bournemouth',coords:[50.7209,-1.9048],region:'South West'},
        {name:'Bracknell',coords:[51.416,-0.753],region:'South East'},
        {name:'Brighton',coords:[50.8225,-0.1372],region:'South East'},
        {name:'Cambridge',coords:[52.2053,0.1218],region:'East of England'},
        {name:'Cardiff',coords:[51.4816,-3.1791],region:'Wales',main:true},
        {name:'Crawley',coords:[51.1091,-0.1872],region:'South East'},
        {name:'Croydon',coords:[51.3762,-0.0982],region:'South East'},
        {name:'Exeter',coords:[50.7184,-3.5339],region:'South West'},
        {name:'Farnborough',coords:[51.2828,-0.7571],region:'South East'},
        {name:'Glasgow',coords:[55.8642,-4.2518],region:'Scotland',main:true},
        {name:'Guildford',coords:[51.2362,-0.5704],region:'South East'},
        {name:'Heathrow',coords:[51.47,-0.4543],region:'South East'},
        {name:'High Wycombe',coords:[51.628,-0.748],region:'South East'},
        {name:'Leicester',coords:[52.6369,-1.1398],region:'East Midlands'},
        {name:'Maidenhead',coords:[51.5223,-0.7199],region:'South East'},
        {name:'Maidstone',coords:[51.2721,0.5347],region:'South East'},
        {name:'Milton Keynes',coords:[52.0406,-0.7594],region:'South East'},
        {name:'Newcastle',coords:[54.9783,-1.6178],region:'North East',main:true},
        {name:'Northampton',coords:[52.2405,-0.9027],region:'East Midlands'},
        {name:'Norwich',coords:[52.6309,1.2974],region:'East of England'},
        {name:'Nottingham',coords:[52.9548,-1.1581],region:'East Midlands'},
        {name:'Oxford',coords:[51.752,-1.2577],region:'South East'},
        {name:'Portsmouth',coords:[50.8198,-1.088],region:'South East'},
        {name:'Preston',coords:[53.7632,-2.7031],region:'North West'},
        {name:'Richmond',coords:[51.4613,-0.303],region:'South East'},
        {name:'Sheffield',coords:[53.3811,-1.4701],region:'Yorkshire & Humber',main:true},
        {name:'Slough',coords:[51.5105,-0.5954],region:'South East'},
        {name:'Southampton',coords:[50.9097,-1.4044],region:'South East'},
        {name:'St Albans',coords:[51.7527,-0.3394],region:'South East'},
        {name:'Staines',coords:[51.435,-0.5034],region:'South East'},
        {name:'Swindon',coords:[51.56,-1.78],region:'South West'},
        {name:'Uxbridge',coords:[51.546,-0.482],region:'South East'},
        {name:'Watford',coords:[51.6565,-0.3903],region:'South East'},
        {name:'Woking',coords:[51.3168,-0.5589],region:'South East'},
        {name:'Luton',coords:[51.8787,-0.42],region:'East of England'},
        {name:'Swansea',coords:[51.6214,-3.9439],region:'Wales'},
        {name:'Warrington',coords:[53.3925,-2.5802],region:'North West'}
      ];
      // Ensure any ligature characters are converted to plain text for consistency
      const LIG_MAP={"\uFB00":"ff","\uFB01":"fi","\uFB02":"fl","\uFB03":"ffi","\uFB04":"ffl","\uFB05":"ft","\uFB06":"st"};
      function cleanName(name){
        return name.normalize('NFKD')
          .replace(/[\uFB00-\uFB06]/g,ch=>LIG_MAP[ch]||'')
          .replace(/Shef[^a-zA-Z]*eld/i,'Sheffield')
          .replace(/[^\x20-\x7E]/g,'');
      }
      LOCS.forEach(loc=>{ loc.name = cleanName(loc.name); });



      const REGIONS=[
        {name:'All UK',center:[55.149843,-3.262972],zoom:4.5},
        {name:'London',center:[51.5072,-0.1276],zoom:11},
        {name:'South East',center:[51.45,-0.7],zoom:8},
        {name:'South West',center:[51,-3],zoom:7},
        {name:'East Midlands',center:[52.9,-1.2],zoom:7},
        {name:'West Midlands',center:[52.5,-2],zoom:7},
        {name:'North West',center:[53.8,-2.8],zoom:7},
        {name:'North East',center:[55,-1.6],zoom:7},
        {name:'Yorkshire & Humber',center:[53.8,-1.5],zoom:7},
        {name:'East of England',center:[52.2,0.5],zoom:7},
        {name:'Wales',center:[52.3,-3.8],zoom:7},
        {name:'Scotland',center:[56.5,-4],zoom:6},
        {name:'Northern Ireland',center:[54.7,-6.6],zoom:7}
      ];

      const $=id=>document.getElementById(id);
      // variables used across functions and map setup
      let map, regionToggle, showMarkers, highlightSelections, choicePopup;
      // ---------- helpers ----------
      // more precise sqm to sqft conversion
      const SQM_TO_SQFT = 10.76391041671;
      const BASE_SQM_PER_PERSON = 12.5;
      function renderResult(el,label,valueStr){
        el.innerHTML=`<span class="result-label">${label}</span><span class="result-value">${valueStr}</span>`;
      }
      function updateScrollbars(){
        document.querySelectorAll('.result-scroll').forEach(el=>{
          if(el.scrollWidth - el.clientWidth > 1) el.classList.add('need-scroll');
          else el.classList.remove('need-scroll');
        });
      }
      // -----------------------------
      const locSel=$('locationSelect');
      const locSel2=$('locationSelect2');
      const removeLoc2=$('removeLoc2');
      const loc2Wrap=$('loc2Wrap');
      const comparePrompt=$('comparePrompt');
      const calcClear=$('calcClear');
      const typeSel=$('typeSelect');
      const modeGroup=$('modeBtns'); const ageGroup=$('ageBtns');
      const modeButtons=modeGroup.querySelectorAll('button');
      const ageButtons=ageGroup.querySelectorAll('button');
      let modeValue='';
      let ageValue='';
      const pplInp=$('peopleInput'); const budInp=$('budgetInput');
      const pplGrp=$('peopleGroup'); const budGrp=$('budgetGroup');
      const calcBtn=$('calcBtn');
      const calcBtnWrap=$('calcBtnWrap');
      const areaR1=$('areaResult1'); const costR1=$('costResult1'); const pplR1=$('peopleResult1');
      const areaR2=$('areaResult2'); const costR2=$('costResult2'); const pplR2=$('peopleResult2');
      const resultContainer=$('resultContainer');
      const title1=$('resultTitle1'); const title2=$('resultTitle2'); const box2=$('resultBox2'); const resWrap=$('resultWrapper');
      const errs={mode:$('modeError'),location:$('locationError'),age:$('ageError'),type:$('typeError'),people:$('peopleError'),budget:$('budgetError')};
      const calcWrap=$('calcWrapper'); const occWrap=$('occWrapper');
      const calcTab=$('calcTab'); const occTab=$('occTab');
      const occBars=$("occBars"); const occTables=$("occTables"); const occClear=$("occClear"); const occPrompt=$("occPrompt"); const occExpand=$("occExpand");
      const occAddBtn=$('occAddBtn'); const occAddSelect=$('occAddSelect'); const occAddSelectWrap=$('occAddSelectWrap');
      const occFilterBtn=$('occFilterBtn'); const occFilterMenu=$('occFilterMenu');
      const filterNew=$('filterNew'); const filterOld=$('filterOld');
      const occExpandWrap=$('occExpandWrap'); const occLimitMsg=$('occLimitMsg');
      const occDownloadWrap=$('occDownloadWrap');
      const downloadBtn=$('downloadBtn');
      const downloadMenu=$('downloadMenu');
      const downloadCsv=$('downloadCsv');
      const calcDownloadWrap=$('calcDownloadWrap');
      const calcDownloadBtn=$('calcDownloadBtn');
      const calcDownloadMenu=$('calcDownloadMenu');
      const calcDownloadCsv=$('calcDownloadCsv');
      const calcSection=$("calcSection");
      let expanded=false;
      let occData=[];
      let showNew=true, showOld=true;
      // populate locations dropdown with London first then major cities
      const londonLocs=LOCS
        .filter(l=>l.region==='London' && !l.regionMarker)
        .sort((a,b)=>a.name.localeCompare(b.name));
      const mainLocs=LOCS
        .filter(l=>l.main && l.region!=='London')
        .sort((a,b)=>a.name.localeCompare(b.name));
      const otherLocs=LOCS
        .filter(l=>!l.regionMarker && l.region!=='London' && !l.main)
        .sort((a,b)=>a.name.localeCompare(b.name));
      [...londonLocs,...mainLocs,...otherLocs].forEach(loc=>{
        const opt=document.createElement('option');
        const displayName=cleanName(loc.name); // extra sanitisation
        opt.value=displayName;
        opt.textContent=displayName;
        locSel.appendChild(opt);
        locSel2.appendChild(opt.cloneNode(true));
        occAddSelect.appendChild(opt.cloneNode(true));
      });

      modeButtons.forEach(btn=>{
        btn.addEventListener('click',()=>{
          modeValue=btn.dataset.value;
          modeButtons.forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          toggleInputs();
        });
      });
      ageButtons.forEach(btn=>{
        btn.addEventListener('click',()=>{
          ageValue=btn.dataset.value;
          ageButtons.forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          if(!resWrap.classList.contains('hidden')) performCalc();
        });
      });

      function clearErr(){
        Object.values(errs).forEach(e=>e.style.display='none');
        [locSel,typeSel,pplInp,budInp].forEach(el=>el.classList.remove('error'));
        modeGroup.classList.remove('error');
        ageGroup.classList.remove('error');
      }
      function costPerSqm(loc){
        const data=COSTS[loc];
        const age=AGE_MAP[ageValue];
        if(!data||!age||!data[age]) return 0;
        return data[age].totalSqft*SQM_TO_SQFT;
      }
      function toggleInputs(){
        const showPeople=modeValue==='people';
        const showBudget=modeValue==='budget';
        pplGrp.classList.toggle('hidden',!showPeople);
        budGrp.classList.toggle('hidden',!showBudget);
        calcBtnWrap.classList.toggle('mt-3',!showPeople&&!showBudget);
        resWrap.classList.add('hidden');
        calcDownloadWrap.classList.add('hidden');
        if(showPeople) calcBtn.textContent='Calculate cost';
        else if(showBudget) calcBtn.textContent='Calculate capacity';
        else calcBtn.textContent='Calculate';
      }

      function updateComparePrompt(){
        comparePrompt.classList.toggle('hidden',!(locSel.value && !locSel2.value));
        removeLoc2.style.display = locSel2.value ? 'block' : 'none';
      }

      function switchTab(tab){
        if(tab==='calc'){
          calcWrap.classList.remove('hidden');
          occWrap.classList.add('hidden');
          calcTab.classList.add('active');
          occTab.classList.remove('active');
          occPrompt.classList.add('hidden');
        }else{
          calcWrap.classList.add('hidden');
          calcTab.classList.remove('active');
          occTab.classList.add('active');
          updateOccUI();
        }
        // reset map to default view when switching tools
        regionToggle.querySelectorAll('button').forEach((b,i)=>{
          b.classList.toggle('active',i===0);
        });
        showMarkers('All UK');
        map.setView(REGIONS[0].center, REGIONS[0].zoom);
        if(choicePopup) { map.removeLayer(choicePopup); choicePopup=null; }
        highlightSelections(false);
      }
      calcTab.addEventListener('click',()=>switchTab('calc'));
      occTab.addEventListener('click',()=>switchTab('occ'));

      function updateOccUI(){
        occBars.innerHTML="";
        occTables.innerHTML="";
        occLimitMsg.classList.add('hidden');
       if(occData.length===0){
         occWrap.classList.add("hidden");
         occPrompt.classList.remove("hidden");
        occTables.classList.remove('expanded');
        expanded=false;
        occExpand.textContent='Expand';
        occExpandWrap.classList.add('hidden');
        occDownloadWrap.classList.add('hidden');
         return;
       }
        occPrompt.classList.add("hidden");
        occWrap.classList.remove("hidden");
        occExpandWrap.classList.remove('hidden');
        occDownloadWrap.classList.remove('hidden');
        const max=Math.max(...occData.flatMap(d=>[
          d.new?.totalSqft||0,
          d.old?.totalSqft||0
        ]));
        occData.forEach((d,idx)=>{
          const col=document.createElement("div");
          col.className="bar-col flex flex-col items-center justify-between p-2 border rounded h-56 relative";
          const rem=document.createElement('button');
          rem.className='remove-btn';
          rem.innerHTML='&times;';
          rem.addEventListener('click',()=>{occData.splice(idx,1);updateOccUI();});
          col.appendChild(rem);
          const label=document.createElement("div");
          label.className="text-sm font-din-bold mb-1 text-center h-10 flex items-center justify-center";
          label.textContent=d.name;
          const bars=document.createElement("div");
          bars.className="flex-1 flex items-end gap-2";
          const nb=document.createElement("div");
          nb.className="occ-bar-new text-white text-xs flex items-center justify-center w-16";
          nb.style.height="0px";
          nb.innerHTML=`<div class="bar-label">${d.new?`£${d.new.totalSqft.toFixed(2)}`:'N/A'}<br><small>psf</small></div>`;
          const ob=document.createElement("div");
          ob.className="occ-bar-old text-white text-xs flex items-center justify-center w-16";
          ob.style.height="0px";
          ob.innerHTML=`<div class="bar-label">${d.old?`£${d.old.totalSqft.toFixed(2)}`:'N/A'}<br><small>psf</small></div>`;
          bars.appendChild(nb); bars.appendChild(ob);
          const labs=document.createElement("div");
          labs.className="flex gap-2 mt-0.5";
          const labNew=document.createElement('span');
          labNew.className='bar-cat w-16';
          labNew.textContent='New build';
          const labOld=document.createElement('span');
          labOld.className='bar-cat w-16';
          labOld.textContent='20-yr old';
          labs.appendChild(labNew);
          labs.appendChild(labOld);
          col.appendChild(label); col.appendChild(bars); col.appendChild(labs);
          occBars.appendChild(col);
          const wrap=document.createElement('div');
          wrap.className='relative mb-4';
          const table=document.createElement("table");
          table.className="w-full text-sm border-collapse";
          const rem2=rem.cloneNode(true);
          rem2.classList.add('table-remove');
          rem2.addEventListener('click',()=>{occData.splice(idx,1);updateOccUI();});
          wrap.appendChild(rem2);
          const headers=['Total','Net effective rent','Rates','Annualised costs','Hard FM','Soft FM','Management fees','Total per workstation'];
          const keys=['totalSqft','netEffectiveRent','rates','annualisedCosts','hardFM','softFM','managementFees','totalWorkstation'];
          const headRow='<tr class="bg-gray-50"><th class="border px-2 py-1 text-center">Building age</th>'+headers.map((h,i)=>`<th class="border px-2 py-1 text-center${i>=4?' extra-col':''}">${h}</th>`).join('')+'</tr>';
          function buildRow(label,obj){
            if(!obj) return '';
            return '<tr><td class="border px-2 py-1 text-center">'+label+'</td>'+keys.map((k,i)=>{
              const v=obj[k];
              return `<td class="border px-2 py-1 text-center${i>=4?' extra-col':''}">£${k==='totalWorkstation'?Math.round(v).toLocaleString():v.toFixed(2)}</td>`;
            }).join('')+'</tr>';
          }
          let rows='';
          if(showNew) rows+=buildRow('New build',d.new);
          if(showOld) rows+=buildRow('20‑yr old',d.old);
          table.innerHTML=`<thead><tr class="bg-gray-100"><th class="border px-2 py-1 text-center" colspan="${keys.length+1}">${d.name}</th></tr>${headRow}</thead><tbody>${rows}</tbody>`;
          wrap.appendChild(table);
          occTables.appendChild(wrap);
          function applyHeights(){
            nb.style.opacity=showNew?"1":"0";
            ob.style.opacity=showOld?"1":"0";
            labNew.style.opacity=showNew?"1":"0";
            labOld.style.opacity=showOld?"1":"0";
            nb.style.height=showNew&&d.new?(d.new.totalSqft/max*120)+"px":"0px";
            ob.style.height=showOld&&d.old?(d.old.totalSqft/max*120)+"px":"0px";
          }
          setTimeout(applyHeights,20);
        });
        occTables.classList.toggle('expanded', expanded);
        occExpand.textContent = expanded ? 'Collapse' : 'Expand';
      }

      occFilterBtn.addEventListener('click',e=>{
        e.stopPropagation();
        occFilterMenu.classList.toggle('hidden');
      });
      occFilterMenu.addEventListener('click',e=>e.stopPropagation());
      filterNew.addEventListener('change',()=>{showNew=filterNew.checked; updateOccUI();});
      filterOld.addEventListener('change',()=>{showOld=filterOld.checked; updateOccUI();});

      occClear.addEventListener('click',()=>{occData=[]; document.getElementById('occLimitMsg').classList.add('hidden'); updateOccUI();});
      occAddBtn.addEventListener('click',()=>{occAddSelectWrap.classList.toggle('hidden');});
      occAddSelect.addEventListener('change',()=>{
        const val=occAddSelect.value;
        if(!val) return;
        if(occData.length>=3){
          occLimitMsg.classList.remove('hidden');
          return;
        }
        occLimitMsg.classList.add('hidden');
        const cost=COSTS[val]||{};
        occData.push({name:val,new:cost.new||null,old:cost.old||null});
        occAddSelect.value='';
        occAddSelectWrap.classList.add('hidden');
        updateOccUI();
      });
      calcClear.addEventListener('click',()=>{
        modeValue=''; ageValue='';
        [locSel,locSel2,typeSel,pplInp,budInp].forEach(el=>{el.value='';});
        modeButtons.forEach(b=>b.classList.remove('active'));
        ageButtons.forEach(b=>b.classList.remove('active'));
        loc2Wrap.classList.add('hidden');
        resWrap.classList.add('hidden');
        calcDownloadWrap.classList.add('hidden');
        resetMarkers();
        updateComparePrompt();
        toggleInputs();
        highlightSelections(false);
      });
      removeLoc2.addEventListener('click',()=>{
        locSel2.value='';
        loc2Wrap.classList.add('hidden');
        highlightSelections();
        updateComparePrompt();
        if(!resWrap.classList.contains('hidden')) performCalc();
      });
      occExpand.addEventListener('click',()=>{expanded=!expanded; updateOccUI();});

      function buildCSV(){
        const headers=['Building age','Total','Net effective rent','Rates','Annualised costs','Hard FM','Soft FM','Management fees','Total per workstation'];
        const lines=[];
        function row(label,obj){
          return [
            label,
            `£${obj.totalSqft.toFixed(2)}`,
            `£${obj.netEffectiveRent.toFixed(2)}`,
            `£${obj.rates.toFixed(2)}`,
            `£${obj.annualisedCosts.toFixed(2)}`,
            `£${obj.hardFM.toFixed(2)}`,
            `£${obj.softFM.toFixed(2)}`,
            `£${obj.managementFees.toFixed(2)}`,
            `"£${Math.round(obj.totalWorkstation).toLocaleString()}"`
          ].join(',');
        }
        occData.forEach(d=>{
          lines.push(d.name);
          lines.push(headers.join(','));
          if(showNew) lines.push(row('New build',d.new));
          if(showOld) lines.push(row('20-yr old',d.old));
          lines.push('');
        });
        return lines.join('\r\n');
      }

      function downloadFile(){
        const csv='\uFEFF'+buildCSV();
        const blob=new Blob([csv],{type:'text/csv'});
        const link=document.createElement('a');
        link.href=URL.createObjectURL(blob);
        link.download='occupancy-costs.csv';
        document.body.appendChild(link);
        link.click();
        setTimeout(()=>{document.body.removeChild(link); URL.revokeObjectURL(link.href);},0);
      }

      function buildCalcCSV(){
        const usePeople=modeValue==='people';
        const metricHeaders=usePeople?
          ['Area required (m\u00B2)','Area required (ft\u00B2)','Annual cost (\u00A3)']:
          ['Area achievable (m\u00B2)','Area achievable (ft\u00B2)','People accommodated'];
        const header=['Location','Building age',usePeople?'People':'Budget (\u00A3)','Workstation type',...metricHeaders];
        const ageLabel=ageValue==='New'? 'New build':'20-yr old';
        const typeLabel=typeSel.value || '';
        const lines=[header.join(',')];
        const sqmPerPerson=BASE_SQM_PER_PERSON*TYPE_SPACE[typeSel.value];
        const n=usePeople?parseInt(pplInp.value,10):0;
        const budget=!usePeople?parseInt(budInp.value.replace(/,/g,''),10):0;
        function q(str){return `"${String(str).replace(/"/g,'""')}"`;}
        function addRow(loc){
          const cpsqm=costPerSqm(loc);
          if(usePeople){
            const sqm=n*sqmPerPerson;
            const sqft=sqm*SQM_TO_SQFT;
            const cost=Math.round(sqm*cpsqm);
            lines.push([
              q(loc),
              ageLabel,
              n,
              q(typeLabel),
              sqm.toFixed(2),
              sqft.toFixed(0),
              cost
            ].join(','));
          }else{
            const sqm=budget/cpsqm;
            const sqft=sqm*SQM_TO_SQFT;
            const ppl=Math.round(sqm/sqmPerPerson);
            lines.push([
              q(loc),
              ageLabel,
              q(budInp.value),
              q(typeLabel),
              Math.round(sqm),
              Math.round(sqft),
              ppl
            ].join(','));
          }
        }
        addRow(locSel.value);
        if(locSel2.value) addRow(locSel2.value);
        return lines.join('\r\n');
      }

      function downloadCalcFile(){
        const csv='\uFEFF'+buildCalcCSV();
        const blob=new Blob([csv],{type:'text/csv'});
        const link=document.createElement('a');
        link.href=URL.createObjectURL(blob);
        link.download='space-calculator.csv';
        document.body.appendChild(link);
        link.click();
        setTimeout(()=>{document.body.removeChild(link); URL.revokeObjectURL(link.href);},0);
      }

      downloadBtn.addEventListener('click',e=>{
        e.stopPropagation();
        downloadMenu.classList.toggle('hidden');
      });
      downloadMenu.addEventListener('click',e=>e.stopPropagation());
      downloadCsv.addEventListener('click',()=>{downloadFile(); downloadMenu.classList.add('hidden');});

      calcDownloadBtn.addEventListener('click',e=>{e.stopPropagation(); calcDownloadMenu.classList.toggle('hidden');});
      calcDownloadMenu.addEventListener('click',e=>e.stopPropagation());
      calcDownloadCsv.addEventListener('click',()=>{downloadCalcFile(); calcDownloadMenu.classList.add('hidden');});

      document.addEventListener('click',()=>{
        occFilterMenu.classList.add('hidden');
        downloadMenu.classList.add('hidden');
        calcDownloadMenu.classList.add('hidden');
      });

      // auto‑comma budget
      budInp.addEventListener('input',()=>{
        const raw=budInp.value.replace(/[^0-9]/g,'');
        budInp.value=raw?parseInt(raw,10).toLocaleString():'';
        if(!budGrp.classList.contains('hidden') && !resWrap.classList.contains('hidden')) performCalc();
      });

      pplInp.addEventListener('input',()=>{
        if(!pplGrp.classList.contains('hidden') && !resWrap.classList.contains('hidden')) performCalc();
      });

      function performCalc(){
        clearErr(); let bad=false;
        if(!modeValue){errs.mode.style.display='block'; modeGroup.classList.add('error'); bad=true; }
        if(!locSel.value){errs.location.style.display='block'; locSel.classList.add('error'); bad=true; }
        if(!ageValue){errs.age.style.display='block'; ageGroup.classList.add('error'); bad=true; }
        if(!typeSel.value){errs.type.style.display='block'; typeSel.classList.add('error'); bad=true; }

        const usePeople=modeValue==='people';
        let n,budget; const sqmPerPerson=BASE_SQM_PER_PERSON*TYPE_SPACE[typeSel.value];
        if(usePeople){
          n=parseInt(pplInp.value,10);
          if(!n||n<=0){errs.people.style.display='block'; pplInp.classList.add('error'); bad=true; }
        }else if(modeValue==='budget'){
          budget=parseInt(budInp.value.replace(/,/g,''),10);
          if(!budget||budget<=0){errs.budget.style.display='block'; budInp.classList.add('error'); bad=true; }
        }
        if(bad) return;
       function calcLoc(loc,areaEl,costEl,pplEl,titleEl){
         const cpsqm=costPerSqm(loc);
         titleEl.textContent=loc;
          if(usePeople){
            const sqm=n*sqmPerPerson;
            renderResult(areaEl,'Area required',`${sqm.toLocaleString()} m² / ${(sqm*SQM_TO_SQFT).toLocaleString(undefined,{maximumFractionDigits:0})} ft²`);
            renderResult(costEl,'Annual cost',`£${Math.round(sqm*cpsqm).toLocaleString()}`);
            pplEl.innerHTML='';
          }else{
            const sqm=budget/cpsqm;
            renderResult(areaEl,'Area achievable',`${Math.round(sqm).toLocaleString()} m² / ${Math.round(sqm*SQM_TO_SQFT).toLocaleString()} ft²`);
            renderResult(pplEl,'People accommodated',`${Math.round(sqm/sqmPerPerson).toLocaleString()}`);
            costEl.innerHTML='';
          }
        }
       calcLoc(locSel.value,areaR1,costR1,pplR1,title1);
       if(locSel2.value){
         calcLoc(locSel2.value,areaR2,costR2,pplR2,title2);
         box2.classList.remove('hidden');
        resultContainer.classList.add('compare');
        resultContainer.classList.remove('single');
       }else{
         box2.classList.add('hidden');
        resultContainer.classList.add('single');
       resultContainer.classList.remove('compare');
       }
       resWrap.classList.remove('hidden');
       resWrap.classList.remove('fade-in'); void resWrap.offsetWidth; resWrap.classList.add('fade-in');
       calcDownloadWrap.classList.remove('hidden');
       updateComparePrompt();
       updateScrollbars();
       setTimeout(updateScrollbars,50);
      }

      calcBtn.addEventListener('click',performCalc);
      typeSel.addEventListener('change',()=>{if(!resWrap.classList.contains('hidden')) performCalc();});

      toggleInputs(); // initialise visibility
      updateComparePrompt();

      // Map ------------------------------------------------------------------
      if(typeof L!=='undefined'){
        const map=L.map('map',{zoomControl:false,attributionControl:false}).setView(REGIONS[0].center,REGIONS[0].zoom);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png',{subdomains:'abcd',attribution:'&copy; OpenStreetMap & CartoDB'}).addTo(map);

        function tooltipDir(latlng){
          const p=map.latLngToContainerPoint(latlng);
          const size=map.getSize();
          if(p.x<80) return "right";
          if(size.x-p.x<80) return "left";
          if(p.y<40||size.y-p.y<40) return "right";
          return "top";
        }
        function comparePopupConfig(latlng){
          const ttDir=tooltipDir(latlng);
          const p=map.latLngToContainerPoint(latlng);
          const size=map.getSize();
          if(ttDir==='top'){
            if(size.y-p.y>80) return {dir:'bottom',offset:[0,8]};
            return {dir:p.x>size.x/2?'left':'right',offset:[p.x>size.x/2?-8:8,0]};
          }else{ // tooltip to the right
            if(p.x>120) return {dir:'left',offset:[-8,0]};
            return {dir:(size.y-p.y>80?'bottom':'top'),offset:[0,(size.y-p.y>80?8:-8)]};
          }
        }
        function ensurePopupVisible(latlng){
          const p=map.latLngToContainerPoint(latlng);
          const size=map.getSize();
          const padX=100, padY=60;
          let dx=0, dy=0;
          if(p.x<padX) dx=padX-p.x;
          else if(size.x-p.x<padX) dx=-(padX-(size.x-p.x));
          if(p.y<padY) dy=padY-p.y;
          else if(size.y-p.y<padY) dy=-(padY-(size.y-p.y));
          if(dx||dy) map.panBy([dx,dy],{animate:false});
        }
        regionToggle=$('regionToggle');
        REGIONS.forEach(({name,center,zoom},i)=>{
          const btn=document.createElement('button');
          btn.textContent=name;
          btn.className='region-btn'+(i===0?' active':'');
          btn.addEventListener('click',()=>{
            regionToggle.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
            btn.classList.add('active');
            showMarkers(name);
            const r=REGIONS.find(r=>r.name===name);
            if(r) map.setView(r.center,r.zoom);
            highlightSelections(false);
          });
          regionToggle.appendChild(btn);
        });

        const markers={};
        choicePopup=null;
        function resetMarkers(){Object.values(markers).forEach(m=>m.setStyle({stroke:false,color:'var(--lsh-red)',fillColor:'var(--lsh-red)'}));}
       highlightSelections=function(showTips=true){
          const activeBtn = regionToggle.querySelector('button.active');
          const region = activeBtn ? activeBtn.textContent : 'All UK';
          showMarkers(region);
          // close any previously opened tooltips
          Object.values(markers).forEach(m=>m.closeTooltip());
          const coords=[];
          const activeMarkers=[];
          [locSel.value,locSel2.value].forEach(n=>{
            if(n){
              const m=markers[n];
              if(m){
                if(!map.hasLayer(m)) m.addTo(map);
                m.setStyle({stroke:false,color:'var(--lsh-red-dark)',fillColor:'var(--lsh-red-dark)'});
                activeMarkers.push(m);
                coords.push(m.getLatLng());
              }
            }
          });

          function openTips(){
            activeMarkers.forEach(m=>{
              const tt=m.getTooltip();
              tt.options.direction=tooltipDir(m.getLatLng());
              tt.update();
              m.openTooltip();
            });
          }

          if(showTips){
            if(coords.length===1){
              map.once('moveend',openTips);
              map.setView(coords[0], map.getZoom());
              setTimeout(openTips,0);
            }else if(coords.length===2){
              map.once('moveend',openTips);
              const bounds=L.latLngBounds(coords);
              let zoom=map.getBoundsZoom(bounds,false,[120,120]);
              const dist=coords[0].distanceTo(coords[1]);
              if(dist<500) zoom=Math.max(zoom,16);
              else if(dist<1000) zoom=Math.max(zoom,15);
              else if(dist<2000) zoom=Math.max(zoom,14);
              map.setView(bounds.getCenter(),zoom);
              setTimeout(openTips,0);
            }else{
              openTips();
            }
          }
        }
        LOCS.forEach(loc=>{
          const marker=L.circleMarker(loc.coords,{radius:6,stroke:false,color:'var(--lsh-red)',fillColor:'var(--lsh-red)',fillOpacity:0.9});
          const cost=COSTS[loc.name];
          if(cost){
            let tip = `<div class="text-xs"><div class="tooltip-name font-din-bold text-sm mb-1 text-center">${loc.name}</div>`;
            if(cost.new) tip += `<div class="font-semibold">New build: <span class="font-light">£${cost.new.totalSqft.toFixed(2)} psf</span></div>`;
            if(cost.old) tip += `<div class="font-semibold">20‑yr old: <span class="font-light">£${cost.old.totalSqft.toFixed(2)} psf</span></div>`;
            tip += '</div>';
            marker.bindTooltip(tip,{direction:'top',offset:[0,-8]});
          }else{
            marker.bindTooltip(`<div class="tooltip-name font-din-bold text-sm text-center">${loc.name}</div>`,{direction:'top',offset:[0,-8]});
          }
          marker.on('mouseover',function(){
            const tt=this.getTooltip();
            tt.options.direction=tooltipDir(this.getLatLng());
            tt.update();
            this.openTooltip();
          });
          marker.on('mouseout',function(){this.closeTooltip();});
          marker.on('click',()=>{
            if(loc.regionMarker){
              const region=REGIONS.find(r=>r.name===loc.region);
              if(region){
                regionToggle.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
                const btn=Array.from(regionToggle.children).find(b=>b.textContent===region.name);
                if(btn) btn.classList.add('active');
                showMarkers(region.name);
                map.setView(region.center,region.zoom);
              }
              return;
            }
            resetMarkers();
            marker.setStyle({stroke:false,color:'var(--lsh-red-dark)',fillColor:'var(--lsh-red-dark)'});
            {
              const tt=marker.getTooltip();
              tt.options.direction=tooltipDir(marker.getLatLng());
              tt.update();
              marker.openTooltip();
            }
            if(calcTab.classList.contains('active')){
              if(!locSel.value){
                locSel.value=loc.name;
                loc2Wrap.classList.remove('hidden');
                updateComparePrompt();
                if(!resWrap.classList.contains('hidden')) performCalc();
              }else if(locSel.value!==loc.name && !locSel2.value){
                if(choicePopup) map.removeLayer(choicePopup);
                const cfg=comparePopupConfig(marker.getLatLng());
                ensurePopupVisible(marker.getLatLng());
                choicePopup=L.tooltip({direction:cfg.dir,interactive:true,className:'compare-popup',opacity:1,offset:cfg.offset})
                  .setLatLng(loc.coords)
                  .setContent(`<div class="compare-popup flex gap-2"><button class="btn btn-red" id="calcCmpBtn">Compare</button><button class="btn btn-gray" id="calcRepBtn">Replace</button></div>`)
                  .addTo(map);
                setTimeout(()=>{
                  document.getElementById('calcCmpBtn').addEventListener('click',()=>{
                    map.removeLayer(choicePopup); choicePopup=null;
                locSel2.value=loc.name;
                loc2Wrap.classList.remove('hidden');
                performCalc();
                updateComparePrompt();
                highlightSelections();
              });
              document.getElementById('calcRepBtn').addEventListener('click',()=>{
                map.removeLayer(choicePopup); choicePopup=null;
                locSel.value=loc.name;
                loc2Wrap.classList.remove('hidden');
                performCalc();
                updateComparePrompt();
                highlightSelections();
              });
                },0);
              }else if(locSel.value!==loc.name){
                if(choicePopup) map.removeLayer(choicePopup);
                const cfg=comparePopupConfig(marker.getLatLng());
                ensurePopupVisible(marker.getLatLng());
                const content = locSel2.value
                  ? `<div class="compare-popup flex flex-col gap-1"><button class="btn btn-gray" id="repLoc1Btn">Replace location 1</button><button class="btn btn-gray" id="repLoc2Btn">Replace location 2</button></div>`
                  : `<div class="compare-popup"><button class="btn btn-gray" id="calcRepBtn">Replace</button></div>`;
                choicePopup=L.tooltip({direction:cfg.dir,interactive:true,className:'compare-popup',opacity:1,offset:cfg.offset})
                  .setLatLng(loc.coords)
                  .setContent(content)
                  .addTo(map);
                setTimeout(()=>{
                  if(locSel2.value){
                    document.getElementById('repLoc1Btn').addEventListener('click',()=>{
                      map.removeLayer(choicePopup); choicePopup=null;
                      locSel.value=loc.name;
                      loc2Wrap.classList.remove('hidden');
                      performCalc();
                      updateComparePrompt();
                      highlightSelections();
                    });
                    document.getElementById('repLoc2Btn').addEventListener('click',()=>{
                      map.removeLayer(choicePopup); choicePopup=null;
                      locSel2.value=loc.name;
                      loc2Wrap.classList.remove('hidden');
                      performCalc();
                      updateComparePrompt();
                      highlightSelections();
                    });
                  }else{
                    document.getElementById('calcRepBtn').addEventListener('click',()=>{
                      map.removeLayer(choicePopup); choicePopup=null;
                      locSel2.value=loc.name;
                      loc2Wrap.classList.remove('hidden');
                      performCalc();
                      updateComparePrompt();
                      highlightSelections();
                    });
                  }
                },0);
            }else{
              locSel.value=loc.name;
              if(!resWrap.classList.contains('hidden')) performCalc();
              highlightSelections();
            }
            } else if(occTab.classList.contains('active')){
              const cost=COSTS[loc.name]||{};
              const newCost=cost.new||null;
              const oldCost=cost.old||null;
              if(choicePopup) map.removeLayer(choicePopup);
              if(occData.length>0){
                let content;
                if(occData.length>=3){
                  const btns = occData.map((_,i)=>`<button class="btn btn-gray repOpt" data-idx="${i}">Replace location ${i+1}</button>`).join('');
                  content = `<div class="compare-popup flex flex-col gap-1">${btns}</div>`;
                }else{
                  content = `<div class="compare-popup flex gap-2"><button class="btn btn-red" id="cmpBtn">Compare</button><button class="btn btn-gray" id="repBtn">Replace</button></div>`;
                }
                const cfg=comparePopupConfig(marker.getLatLng());
                ensurePopupVisible(marker.getLatLng());
                choicePopup=L.tooltip({direction:cfg.dir,interactive:true,className:'compare-popup',opacity:1,offset:cfg.offset})
                  .setLatLng(loc.coords)
                  .setContent(content)
                  .addTo(map);
                setTimeout(()=>{
                  const cmp=document.getElementById('cmpBtn');
                  if(cmp){
                    cmp.addEventListener('click',()=>{
                      map.removeLayer(choicePopup); choicePopup=null;
                      document.getElementById('occLimitMsg').classList.add('hidden');
                      occData.push({name:loc.name,new:newCost,old:oldCost});
                      updateOccUI();
                    });
                  }
                  const rep=document.getElementById('repBtn');
                  if(rep){
                    rep.addEventListener('click',()=>{
                      map.removeLayer(choicePopup); choicePopup=null;
                      document.getElementById('occLimitMsg').classList.add('hidden');
                      occData[occData.length-1]={name:loc.name,new:newCost,old:oldCost};
                      updateOccUI();
                    });
                  }
                  document.querySelectorAll('.repOpt').forEach(btn=>{
                    btn.addEventListener('click',()=>{
                      const idx=+btn.dataset.idx;
                      map.removeLayer(choicePopup); choicePopup=null;
                      document.getElementById('occLimitMsg').classList.add('hidden');
                      occData[idx]={name:loc.name,new:newCost,old:oldCost};
                      updateOccUI();
                    });
                  });
                },0);
              }else{
                document.getElementById('occLimitMsg').classList.add('hidden');
                occData=[{name:loc.name,new:newCost,old:oldCost}];
                updateOccUI();
              }
            }
          });
          markers[loc.name]=marker;
        });

        showMarkers=function(region,all=false){
          Object.values(markers).forEach(m=>{ if(map.hasLayer(m)) m.remove(); });
          const coords=[];
          LOCS.forEach(loc=>{
            if(region==='All UK'){
              if(all || loc.main){ markers[loc.name].addTo(map); coords.push(loc.coords); }
            }else if(loc.region===region){
              if(loc.name==='London') return;
              markers[loc.name].addTo(map);
              coords.push(loc.coords);
            }
          });
          resetMarkers();
          return coords.length? L.latLngBounds(coords): null;
        }

        showMarkers('All UK');
        highlightSelections(false);
        switchTab('calc');

        // respond to location dropdown changes
        locSel.addEventListener('change',()=>{
          const selected=LOCS.find(l=>l.name===locSel.value);
          if(!selected) return;
          const region=REGIONS.find(r=>r.name===selected.region);
          loc2Wrap.classList.remove('hidden');
          if(region && locSel2.value){
            regionToggle.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
            const btn=Array.from(regionToggle.children).find(b=>b.textContent===region.name);
            if(btn) btn.classList.add('active');
            showMarkers(region.name);
            map.setView(region.center,region.zoom);
          }
          resetMarkers();
          highlightSelections();
          if(!resWrap.classList.contains('hidden')) performCalc();
          updateComparePrompt();
        });

        locSel2.addEventListener('change',()=>{
          const selected=LOCS.find(l=>l.name===locSel2.value);
          if(!selected) return;
          loc2Wrap.classList.remove('hidden');
          regionToggle.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
          showMarkers('All UK');
          resetMarkers();
          highlightSelections();
          if(!resWrap.classList.contains('hidden')) performCalc();
          updateComparePrompt();
        });

        window.addEventListener('load',()=>{
          setTimeout(()=>map.invalidateSize(),0);
          updateScrollbars();
        });
        window.addEventListener('resize',updateScrollbars);

      }
    })();
  </script>
</body>
</html>


