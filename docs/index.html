<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Explore costs | Lambert Smith Hampton</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind CSS for quick layout -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <!-- DIN Pro font -->
  <link href="https://fonts.cdnfonts.com/css/dinpro" rel="stylesheet" />
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <style>
    :root { --lsh-red:#cc2030; --lsh-red-dark:#871720; }
    body { font-family:'DINPro','DIN Pro',Arial,sans-serif; font-feature-settings:'liga' 0; -webkit-font-feature-settings:'liga' 0; }
    h1,h2 { font-family:'DINPro','DIN Pro',Arial,sans-serif; }
    .font-din-bold{ font-family:'DINPro Bold','DINPro',Arial,sans-serif; font-weight:700; }
    .font-din-light{ font-family:'DINPro Light','DINPro',Arial,sans-serif; font-weight:300; }
    .font-din-regular{ font-family:'DINPro','DIN Pro',Arial,sans-serif; font-weight:400; }
    .text-lsh-red{ color:var(--lsh-red); }
    .bg-lsh-red{ background-color:var(--lsh-red); }
    .hover\:bg-lsh-red-dark:hover{ background-color:#b51c2a; }
    #map{ width:100%; height:420px; }
    .region-btn{ background:#e5e7eb; padding:0.25rem 0.5rem; border-radius:0.25rem; font-size:0.875rem; cursor:pointer; }
    .region-btn:hover{ background:#d1d5db; }
    .region-btn.active{ background:var(--lsh-red); color:#fff; }
    .select-btn{ background:#e5e7eb; padding:0.25rem 0.5rem; border-radius:0.25rem; font-size:0.875rem; cursor:pointer; }
    .select-btn:hover{ background:#d1d5db; }
    .select-btn.active{ background:var(--lsh-red); color:#fff; }
    input[type="checkbox"]{ accent-color:var(--lsh-red); }
    .error{ border-color:#dc2626!important; }
    .err-msg{ display:none; color:#dc2626; font-size:0.75rem; }
    .info-icon{display:inline-block;border:1px solid #9ca3af;border-radius:50%;width:1rem;height:1rem;line-height:1rem;text-align:center;font-size:0.75rem;cursor:pointer;color:#9ca3af;}
    /* result label (smaller, lighter) */
    .result-label{
      font-size:0.875rem;          /* text-sm */
      font-weight:500;             /* medium */
      color:#4b5563;               /* gray-700 */
      display:block;
      line-height:1.2;
      white-space:nowrap;
    }
    .result-label.wrap{
      white-space:normal;
    }
    /* result value (larger, bolder) */
    .result-value{
      font-size:1.875rem;          /* text-3xl */
      font-weight:700;             /* bold */
      color:#111827;               /* gray-900 */
      display:block;
      line-height:1.2;
      white-space:nowrap;
    }
    .result-item{
      background:#f9fafb;          /* gray-50 */
      padding:0.75rem 1rem;        /* px-4 py-3 */
      border-radius:0.375rem;      /* rounded */
      display:flex;
      flex-direction:column;
      flex:0 1 12rem;              /* shrink to fit container */
      box-sizing:border-box;
      text-align:left;
    }
    .result-item.hybrid-highlight{border:2px solid var(--lsh-red);}
    .result-item + .result-item{margin-top:0.5rem;}
    .result-scroll{
      overflow-x:hidden;
      overflow-y:hidden;
      scrollbar-gutter:stable both-edges;
      text-align:left;
    }
    .result-scroll.need-scroll{overflow-x:auto;}
    #resultContainer .result-scroll{
      display:flex;
      flex-wrap:wrap;
      gap:0.5rem;
      justify-content:flex-start;
      overflow:visible;
      width:100%;
    }
    #resultContainer .result-scroll.need-scroll{overflow:visible;}
    .result-title{
      white-space:normal;
      overflow-wrap:anywhere;
      min-height:2.5rem;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      background:#e5e7eb;
      padding:0.5rem 1rem;
      border-radius:0.375rem;
      width:100%;
      box-sizing:border-box;
    }
    #resultContainer.compare .result-value{font-size:1.5rem;}
    #resultContainer.compare #areaResult1 .result-value,
    #resultContainer.compare #areaResult2 .result-value{font-size:1.35rem;}
    #resultContainer.single{text-align:left;grid-template-columns:1fr;}
    @media (min-width:768px){#resultContainer.single{grid-template-columns:1fr;}}
    #resultContainer.compare{text-align:left;}
    .tab-btn{padding:0.5rem 1rem;border-bottom:2px solid transparent;}
    .tab-btn.active{border-color:var(--lsh-red);color:var(--lsh-red);font-weight:700;}
    .occ-bar-new{background:var(--lsh-red);transition:height .3s ease,opacity .3s ease;}
    .occ-bar-old{background:#6b7280;transition:height .3s ease,opacity .3s ease;}
    .tooltip-name{color:var(--lsh-red);background:none;border-radius:0;padding:0;}
    .compare-popup .btn{padding:0.25rem 0.5rem;font-size:0.75rem;border-radius:0.25rem;}
    .compare-popup .btn-red{background:var(--lsh-red);color:#fff;}
    .compare-popup .btn-gray{background:#e5e7eb;color:#111827;}
    .remove-btn{position:absolute;top:0;right:0;padding:0 0.25rem;line-height:1;font-size:0.875rem;}
    .remove-btn:hover{color:var(--lsh-red);}
    .table-remove{position:sticky;right:0;top:0;z-index:10;}
    .occ-placeholder{display:flex;align-items:center;justify-content:center;font-size:2rem;color:#cbd5e0;}
    .placeholder-col{border:2px dashed #cbd5e0;}
    /* bar labels */
    .bar-label{line-height:1;text-align:center;}
    .bar-label small{font-size:0.65rem;}
    /* category labels under bars */
    .bar-cat{font-size:0.65rem;line-height:1;text-align:center;}
    /* table extra columns visible by default */
    .extra-col{display:table-cell;}
    /* tables scroll horizontally */
    #occTables table{min-width:52rem;}
    #occTables th{white-space:nowrap;}
    /* allow occupancy bars to scroll horizontally */
    #occBars .bar-col{flex:1 0 8rem;}
    #occBars.placeholder{justify-content:space-evenly;padding:0 0.5rem;}
    button{transition:transform .1s ease;}
    button:active{transform:scale(.95);}
    .fade-in{animation:fadeIn .3s ease;}
    @keyframes fadeIn{from{opacity:0;transform:translateY(.5rem);}to{opacity:1;transform:translateY(0);}}
    /* Use DINPro in dropdowns with ligatures disabled to avoid Sheffield rendering issues */
    select,option{
      font-family:'DINPro','DIN Pro',Arial,sans-serif;
      font-feature-settings:'liga' 0;
      -webkit-font-feature-settings:'liga' 0;
      -moz-font-feature-settings:'liga' 0;
      font-variant-ligatures:none;
    }
    /* option sliders rendered as small grey boxes */
    .density-slider{display:flex;gap:0.5rem;padding:0;}
    .density-line{display:none;}
    .density-option{background:#e5e7eb;border:1px solid #d1d5db;border-radius:0.25rem;flex:1;text-align:center;cursor:pointer;padding:0.25rem 0.5rem;}
    .density-option:hover{background:#d1d5db;}
    .density-option.selected{background:var(--lsh-red);color:#fff;}
    .density-option:focus{outline:none;}
    .density-point{display:none;}
    .density-label{margin-top:0;font-size:0.875rem;display:block;}
    .density-tooltip{display:none;}
    .slider-pop{position:absolute;top:-1.5rem;left:50%;transform:translateX(-50%);background:#e5e7eb;padding:0.25rem 0.5rem;border-radius:0.25rem;font-size:0.875rem;pointer-events:none;}
    .slider-pop-below{top:auto;bottom:-1.5rem;font-size:0.75rem;white-space:nowrap;}
    /* step sliders */
    .step-slider{position:relative;height:1.5rem;}
    .step-line{position:absolute;top:50%;left:0;right:0;height:2px;background:#d1d5db;transform:translateY(-50%);transition:background-color .2s;pointer-events:none;}
    .step-slider:hover .step-line{background:var(--lsh-red);}
    .step-dot{position:absolute;top:50%;width:0.75rem;height:0.75rem;background:#d1d5db;border:2px solid #fff;border-radius:50%;transform:translate(-50%,-50%);transition:background-color .2s,border-color .2s;pointer-events:none;}
    .step-slider:hover .step-dot{border-color:var(--lsh-red);}
    .step-dot.active{background:var(--lsh-red);border-color:var(--lsh-red);}
  </style>
</head>
<body class="bg-gray-50 antialiased">
  <!-- Header -->
  <header class="bg-white shadow">
    <div class="max-w-6xl mx-auto px-4 py-6">
      <h1 class="text-4xl font-din-bold text-gray-900">Explore costs</h1>
      <p class="mt-1 text-gray-600 font-din-light">Use this tool to calculate indicative office costs or space requirements based on your chosen criteria.</p>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-8 grid grid-cols-1 md:grid-cols-2 gap-6">

    <!-- Map -->
    <section class="bg-white p-6 rounded-lg shadow-md order-2 md:order-1" id="mapSection">
      <h2 class="text-2xl md:text-3xl font-din-bold mb-4 text-lsh-red">UK office locations</h2>
      <div id="regionToggle" class="flex flex-wrap gap-2 mb-4"></div>
      <div id="map" class="rounded"></div>
      <p class="mt-4 text-xs text-gray-500 font-din-light">Hover a marker to view rental rates; click to select.</p>
      <div id="contactSection" class="mt-6 hidden">
        <h3 class="text-2xl font-din-bold mb-4">Contact us</h3>
        <div id="contactsContainer" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
      </div>
    </section>

    <!-- Calculator / Occupancy -->
    <section class="bg-white p-6 rounded-lg shadow-md order-1 md:order-2" id="calcSection">
        <h2 class="text-2xl md:text-3xl font-din-bold mb-4 text-lsh-red">Office cost calculator</h2>
      <div class="mb-4 flex gap-2">
        <button id="occTab" class="tab-btn active">Per sq ft costs</button>
        <button id="calcTab" class="tab-btn">Space calculator</button>
      </div>
      <div id="calcWrapper">

        <label class="block text-lg font-din-bold text-gray-700 mb-1">Calculate based on</label>
        <div id="modeBtns" class="flex gap-2 mb-1">
          <button class="select-btn" data-value="people">Number of workstations → cost</button>
          <button class="select-btn" data-value="budget">Budget → capacity</button>
        </div>
        <p id="modeError" class="err-msg mb-3">Please select an option</p>

        <label class="block text-lg font-din-bold text-gray-700 mb-1">Building age</label>
        <div id="ageBtns" class="flex gap-2 mb-1">
          <button class="select-btn" data-value="New">New build</button>
          <button class="select-btn" data-value="20">20‑year old</button>
        </div>
        <p id="ageError" class="err-msg mb-3">Please select building age</p>

        <div class="md:flex gap-4">
          <div id="loc1Wrap" class="flex-1 relative">
            <label for="locationSelect" class="block text-lg font-din-bold text-gray-700 mb-1">Location</label>
            <button id="removeLoc1" class="remove-btn hidden" aria-label="Remove location 1">&times;</button>
            <div>
              <select id="locationSelect" class="w-full border rounded p-2 mb-1 bg-white">
                <option value="" disabled selected>Please select</option>
              </select>
            </div>
            <p id="locationError" class="err-msg mb-3">Please select a location</p>
          </div>
        <div id="loc2Wrap" class="flex-1 hidden relative">
            <label for="locationSelect2" class="block text-lg font-din-bold text-gray-700 mb-1">Location 2</label>
            <button id="removeLoc2" class="remove-btn" style="display:none" aria-label="Remove location 2">&times;</button>
            <div>
              <select id="locationSelect2" class="w-full border rounded p-2 mb-1 bg-white pr-6">
                <option value="" disabled selected>Please select</option>
              </select>
            </div>
          </div>
        </div>
        <p id="comparePrompt" class="text-sm text-gray-500 mb-3 hidden">Select another location on the map to compare results.</p>

        <!-- Staff input -->
        <div id="peopleGroup" class="mb-3 hidden">
          <label for="peopleInput" class="block text-lg font-din-bold text-gray-700 mb-1">How many staff?</label>
          <input type="number" id="peopleInput" class="w-full border rounded p-2" placeholder="e.g. 25" min="1" max="2000" />
          <p id="peopleError" class="err-msg mt-1">Enter a number from 1 to 2,000</p>
        </div>

        <!-- Budget input -->
        <div id="budgetGroup" class="mb-3 hidden">
          <label id="budgetLabel" for="budgetInput" class="block text-lg font-din-bold text-gray-700 mb-1">Annual budget (£)</label>
          <div class="flex items-center gap-2">
            <input type="text" id="budgetInput" inputmode="numeric" class="flex-1 border rounded p-2" placeholder="e.g. 750,000" />
            <button id="budgetToggle" type="button" class="select-btn text-sm whitespace-nowrap">Monthly budget (£)</button>
          </div>
          <p id="budgetError" class="err-msg mt-1">Enter a budget within the allowed maximum</p>
        </div>

        <label class="block text-lg font-din-bold text-gray-700 mb-1">Workstation density</label>
        <div id="densitySliderWrap" class="relative mt-6 mb-8 step-slider">
          <div class="step-line"></div>
          <input type="range" id="densitySlider" min="0" max="2" step="1" value="1" class="absolute inset-0 w-full opacity-0 cursor-pointer" />
          <output id="densityOutput" class="slider-pop"></output>
          <output id="densityDetail" class="slider-pop slider-pop-below hidden"></output>
        </div>
        <input type="hidden" id="densitySelect" value="10" />

        <div id="hybridLegacy" class="mt-4">
          <label id="hybridLabel" class="block text-lg font-din-bold text-gray-700 mb-1 flex items-center relative">Hybrid working factor (optional)
            <span id="hybridInfo" class="info-icon ml-1">i</span>
            <div id="hybridTooltip" class="hidden absolute right-0 mt-1 w-64 bg-white border border-gray-300 p-2 rounded shadow-md text-xs">
              For staff to workstation ratios above 1:1, a 10% buffer is added to workstation numbers to ensure sufficient desks are available during unexpected peaks and / or anchor days.
            </div>
          </label>
          <p class="text-sm text-gray-600 font-din-light mb-1">How many staff per workstation?</p>
          <div id="hybridSliderWrap" class="relative mt-6 mb-10 step-slider">
            <div class="step-line"></div>
            <input type="range" id="hybridSlider" min="0" max="4" step="1" value="0" class="absolute inset-0 w-full opacity-0 cursor-pointer" />
            <output id="hybridOutput" class="slider-pop"></output>
            <output id="hybridDetail" class="slider-pop slider-pop-below hidden"></output>
          </div>
          <input type="hidden" id="hybridSelect" value="1" data-occ="1" />
        </div>

        <div id="extrasSection" class="mb-3 hidden">
          <button id="customiseToggle" type="button" class="select-btn mt-2 flex items-center">Customise discretionary costs
            <svg class="w-4 h-4 ml-1 transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 8l4 4 4-4" />
            </svg>
          </button>
          <div id="extrasWrap" class="mt-2 p-2 border rounded hidden"></div>
        </div>

        <div id="calcBtnWrap" class="flex items-start gap-2 mt-2">
          <div class="flex flex-col flex-1">
            <button id="calcBtn" class="bg-lsh-red hover:bg-lsh-red-dark text-white px-4 py-2 rounded font-din-bold">Calculate</button>
            <select id="costPeriod" class="border rounded p-1 text-sm mt-1 w-32 hidden">
              <option value="annual" selected>Annual</option>
              <option value="monthly">Monthly</option>
            </select>
          </div>
          <button id="calcClear" class="bg-gray-200 hover:bg-gray-300 text-sm px-3 py-2 rounded font-din-bold">Clear</button>
        </div>

        <div id="resultWrapper" class="mt-6 hidden">
          <div id="resultContainer" class="grid md:grid-cols-2 gap-4">
            <div id="resultBox1" class="space-y-3">
              <h3 id="resultTitle1" class="font-din-bold result-title"></h3>
              <div id="areaResult1" class="result-scroll"></div>
              <div id="costResult1" class="result-scroll"></div>
              <div id="peopleResult1" class="result-scroll"></div>
            </div>
            <div id="resultBox2" class="space-y-3 md:border-l md:pl-4 hidden">
              <h3 id="resultTitle2" class="font-din-bold result-title"></h3>
              <div id="areaResult2" class="result-scroll"></div>
              <div id="costResult2" class="result-scroll"></div>
              <div id="peopleResult2" class="result-scroll"></div>
            </div>
          </div>
          <p class="mt-4 text-xs text-gray-500 font-din-light">Indicative costs are based on LSH office costs data, last updated June 2025.</p>
        </div>

        <div id="calcDownloadWrap" class="flex justify-end mt-2 hidden">
          <div class="relative">
            <button id="calcDownloadBtn" class="p-1" aria-label="Download">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a1 1 0 001 1h14a1 1 0 001-1v-1m-5-4l-3 3m0 0l-3-3m3 3V4" />
              </svg>
            </button>
            <div id="calcDownloadMenu" class="absolute right-0 mt-2 bg-white border rounded shadow text-sm p-2 space-y-1 hidden">
              <a id="calcDownloadCsv" href="#" class="block w-full text-left">CSV</a>
            </div>
          </div>
        </div>

      </div>

      <div id="occPrompt" class="mb-4 text-center text-gray-500 hidden"></div>
      <div id="occWrapper">
        <div class="flex justify-between items-center mb-4 relative">
          <button id="occClear" class="bg-gray-200 hover:bg-gray-300 text-sm px-3 py-1 rounded font-din-bold">Clear</button>
          <div class="relative">
            <button id="occFilterBtn" class="p-1" aria-label="Filter">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2a1 1 0 01-.293.707L15 12.414V19a1 1 0 01-.553.894l-4 2A1 1 0 019 21v-8.586L3.293 6.707A1 1 0 013 6V4z" />
              </svg>
            </button>
            <div id="occFilterMenu" class="absolute right-0 mt-2 bg-white border rounded shadow text-sm p-2 space-y-1 hidden z-50">
              <label class="flex items-center gap-1 whitespace-nowrap"><input type="checkbox" id="filterNew" checked> New build</label>
              <label class="flex items-center gap-1 whitespace-nowrap"><input type="checkbox" id="filterOld" checked> 20‑yr old</label>
            </div>
          </div>
        </div>
        <div id="occBars" class="flex gap-4 items-end mb-4 w-full result-scroll"></div>
        <p id="occLimitMsg" class="hidden text-xs text-lsh-red mb-2">You can compare up to 3 locations.</p>
        <div id="occTables"></div>
        <div id="occDownloadWrap" class="flex justify-end mt-2 hidden">
          <div class="relative">
            <button id="downloadBtn" class="p-1" aria-label="Download">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a1 1 0 001 1h14a1 1 0 001-1v-1m-5-4l-3 3m0 0l-3-3m3 3V4" />
              </svg>
            </button>
            <div id="downloadMenu" class="absolute right-0 mt-2 bg-white border rounded shadow text-sm p-2 space-y-1 hidden">
              <a id="downloadCsv" href="#" class="block w-full text-left">CSV</a>
            </div>
          </div>
        </div>
        <p class="text-xs text-gray-500 hidden" id="occUnits">All costs are per sq ft excluding total per workstation.</p>
      </div>
    </section>
  </main>
  <footer class="text-center text-sm text-gray-400 py-6 font-din-light">© Lambert Smith Hampton — Prototype tool for illustration only.</footer>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="costs.js"></script>
  <script src="extras.js"></script>
  <script>
    if(typeof L==='undefined'){console.error('Leaflet failed to load.');}
    (function(){
      const AGE_MAP={ '20':'old', New:'new' };
      const ENABLE_DOWNLOADS=false; // toggle to enable CSV downloads
      const style=getComputedStyle(document.documentElement);
      const LSH_RED=style.getPropertyValue('--lsh-red').trim()||'#cc2030';
      const LSH_RED_DARK=style.getPropertyValue('--lsh-red-dark').trim()||'#871720';
      const LOCS=[
        {name:'Edinburgh',coords:[55.9533,-3.1883],region:'Scotland',main:true},
        {name:'Birmingham',coords:[52.4862,-1.8904],region:'West Midlands',main:true},
        {name:'Bristol',coords:[51.4545,-2.5879],region:'South West',main:true},
        {name:'Liverpool',coords:[53.4084,-2.9916],region:'North West',main:true},
        {name:'Manchester',coords:[53.4808,-2.2426],region:'North West',main:true},
        {name:'Leeds',coords:[53.7997,-1.5492],region:'Yorkshire & Humber',main:true},
        {name:'London',coords:[51.5072,-0.1276],region:'London',main:true,regionMarker:true},
        {name:'Reading',coords:[51.4543,-0.9781],region:'South East'},
        {name:'London - City',coords:[51.5155,-0.0922],region:'London'},
        {name:'London - Docklands',coords:[51.502348,-0.017652],region:'London'},
        {name:'London - Hammersmith',coords:[51.492,-0.223],region:'London'},
        {name:'London - Midtown',coords:[51.517,-0.12],region:'London'},
        {name:'London - Southbank',coords:[51.5067,-0.0995],region:'London'},
        {name:'London - West End Core',coords:[51.512,-0.129],region:'London'},
        {name:'London - West End Non Core',coords:[51.517,-0.143],region:'London'},
        {name:'Aberdeen',coords:[57.1497,-2.0943],region:'Scotland'},
        {name:'Basingstoke',coords:[51.2667,-1.0879],region:'South East'},
        {name:'Belfast',coords:[54.597,-5.93],region:'Northern Ireland',main:true},
        {name:'Bournemouth',coords:[50.7209,-1.9048],region:'South West'},
        {name:'Bracknell',coords:[51.416,-0.753],region:'South East'},
        {name:'Brighton',coords:[50.8225,-0.1372],region:'South East'},
        {name:'Cambridge',coords:[52.2053,0.1218],region:'East of England',main:true},
        {name:'Cardiff',coords:[51.4816,-3.1791],region:'Wales',main:true},
        {name:'Crawley',coords:[51.1091,-0.1872],region:'South East'},
        {name:'Croydon',coords:[51.3762,-0.0982],region:'South East'},
        {name:'Exeter',coords:[50.7184,-3.5339],region:'South West'},
        {name:'Farnborough',coords:[51.2828,-0.7571],region:'South East'},
        {name:'Glasgow',coords:[55.8642,-4.2518],region:'Scotland',main:true},
        {name:'Guildford',coords:[51.2362,-0.5704],region:'South East'},
        {name:'Heathrow',coords:[51.47,-0.4543],region:'South East'},
        {name:'High Wycombe',coords:[51.628,-0.748],region:'South East'},
        {name:'Leicester',coords:[52.6369,-1.1398],region:'East Midlands'},
        {name:'Maidenhead',coords:[51.5223,-0.7199],region:'South East'},
        {name:'Maidstone',coords:[51.2721,0.5347],region:'South East'},
        {name:'Milton Keynes',coords:[52.0406,-0.7594],region:'South East'},
        {name:'Newcastle',coords:[54.9783,-1.6178],region:'North East',main:true},
        {name:'Northampton',coords:[52.2405,-0.9027],region:'East Midlands'},
        {name:'Norwich',coords:[52.6309,1.2974],region:'East of England'},
        {name:'Nottingham',coords:[52.9548,-1.1581],region:'East Midlands'},
        {name:'Oxford',coords:[51.752,-1.2577],region:'South East'},
        {name:'Portsmouth',coords:[50.8198,-1.088],region:'South East'},
        {name:'Preston',coords:[53.7632,-2.7031],region:'North West'},
        {name:'Richmond',coords:[51.4613,-0.303],region:'South East'},
        {name:'Sheffield',coords:[53.3811,-1.4701],region:'Yorkshire & Humber',main:true},
        {name:'Slough',coords:[51.5105,-0.5954],region:'South East'},
        {name:'Southampton',coords:[50.9097,-1.4044],region:'South East'},
        {name:'St Albans',coords:[51.7527,-0.3394],region:'South East'},
        {name:'Staines',coords:[51.435,-0.5034],region:'South East'},
        {name:'Swindon',coords:[51.56,-1.78],region:'South West'},
        {name:'Uxbridge',coords:[51.546,-0.482],region:'South East'},
        {name:'Watford',coords:[51.6565,-0.3903],region:'South East'},
        {name:'Woking',coords:[51.3168,-0.5589],region:'South East'},
        {name:'Luton',coords:[51.8787,-0.42],region:'East of England'},
        {name:'Swansea',coords:[51.6214,-3.9439],region:'Wales'},
        {name:'Warrington',coords:[53.3925,-2.5802],region:'North West'}
      ];
      // Ensure any ligature characters are converted to plain text for consistency
      const LIG_MAP={"\uFB00":"ff","\uFB01":"fi","\uFB02":"fl","\uFB03":"ffi","\uFB04":"ffl","\uFB05":"ft","\uFB06":"st"};
      function cleanName(name){
        return name.normalize('NFKD')
          .replace(/[\uFB00-\uFB06]/g,ch=>LIG_MAP[ch]||'')
          .replace(/[^\x20-\x7E]/g,'');
      }
      function breakLigatures(str){
        return str
          .replace(/ff/g,'f\u200Cf')
          .replace(/fi/g,'f\u200Ci')
          .replace(/fl/g,'f\u200Cl');
      }
      LOCS.forEach(loc=>{ loc.name = cleanName(loc.name); });
      const EXTRAS_CLEAN={};
      Object.keys(EXTRAS).forEach(k=>{
        let clean=cleanName(k).replace(/\s{2,}/g,' - ');
        EXTRAS_CLEAN[clean]=EXTRAS[k];
      });
      if(EXTRAS_CLEAN['London - West End core']){
        EXTRAS_CLEAN['London - West End Core']=EXTRAS_CLEAN['London - West End core'];
        delete EXTRAS_CLEAN['London - West End core'];
      }
      if(EXTRAS_CLEAN['London West End fringe']){
        EXTRAS_CLEAN['London - West End Non Core']=EXTRAS_CLEAN['London West End fringe'];
        delete EXTRAS_CLEAN['London West End fringe'];
      }
      const EXTRA_NAMES=Object.keys(EXTRAS_CLEAN[Object.keys(EXTRAS_CLEAN)[0]]||{});
      const activeExtras=new Set(EXTRA_NAMES);
      const REGIONS=[
        {name:'All UK',center:[55.149843,-3.262972],zoom:4.5},
        {name:'London',center:[51.5072,-0.1276],zoom:11},
        {name:'South East',center:[51.45,-0.7],zoom:8},
        {name:'South West',center:[51,-3],zoom:7},
        {name:'East Midlands',center:[52.9,-1.2],zoom:7},
        {name:'West Midlands',center:[52.5,-2],zoom:7},
        {name:'North West',center:[53.8,-2.8],zoom:7},
        {name:'North East',center:[55,-1.6],zoom:7},
        {name:'Yorkshire & Humber',center:[53.8,-1.5],zoom:7},
        {name:'East of England',center:[52.2,0.5],zoom:7},
        {name:'Wales',center:[52.3,-3.8],zoom:7},
        {name:'Scotland',center:[56.5,-4],zoom:6},
        {name:'Northern Ireland',center:[54.7,-6.6],zoom:7}
      ];

      const $=id=>document.getElementById(id);
      // variables used across functions and map setup
      let map, regionToggle, showMarkers, highlightSelections, choicePopup;
      // ---------- helpers ----------
      // more precise sqm to sqft conversion
      const SQM_TO_SQFT = 10.76391041671;
      const DEFAULT_SQM_PER_PERSON = 10;
      const MAX_ANNUAL_BUDGET  = 50_000_000;
      const MAX_MONTHLY_BUDGET = Math.ceil(MAX_ANNUAL_BUDGET / 12); // 4,166,667
        function renderResult(el,label,valueStr,append=false,highlight=false,labelBelow=false,wrapLabel=false){
          const itemCls=highlight? 'result-item hybrid-highlight':'result-item';
          const valCls=highlight? 'result-value text-lsh-red':'result-value';
          const lblCls=wrapLabel? 'result-label wrap':'result-label';
          const content=labelBelow
            ? `<span class="${valCls}">${valueStr}</span><span class="${lblCls}">${label}</span>`
            : `<span class="${lblCls}">${label}</span><span class="${valCls}">${valueStr}</span>`;
          const html=`<div class="${itemCls}">${content}</div>`;
          if(append) el.innerHTML+=html; else el.innerHTML=html;
        }
      function updateScrollbars(){
        document.querySelectorAll('.result-scroll').forEach(el=>{
          if(el.scrollWidth - el.clientWidth > 1) el.classList.add('need-scroll');
          else el.classList.remove('need-scroll');
        });
      }
      function adjustTitle(el){
        let size=1.5; // rem
        el.style.fontSize=size+'rem';
        while(el.scrollWidth>el.clientWidth && size>0.9){
          size-=0.05;
          el.style.fontSize=size+'rem';
        }
      }
      function updateFieldHighlight(el){
        const hasValue=!!el.value;
        if(hasValue){
          el.classList.add('bg-lsh-red','text-white');
          el.classList.remove('bg-white');
        }else{
          el.classList.remove('bg-lsh-red','text-white');
          if(el.tagName==='SELECT') el.classList.add('bg-white');
        }
      }
      // -----------------------------
      const locSel=$('locationSelect');
      const locSel2=$('locationSelect2');
      const removeLoc1=$('removeLoc1');
      const removeLoc2=$('removeLoc2');
      const loc2Wrap=$('loc2Wrap');
      const comparePrompt=$('comparePrompt');
      const calcClear=$('calcClear');
        const densitySel=$('densitySelect');
        const densitySlider=$('densitySlider');
        const densityOutput=$('densityOutput');
        const densitySliderWrap=$('densitySliderWrap');
        const densityDetail=$('densityDetail');
        const densityDots=[];
      const DENSITIES=[
        {label:'Dense',value:'8',detail:'8 m² per workstation NIA'},
        {label:'Standard',value:'10',detail:'10 m² per workstation NIA'},
        {label:'Spacious',value:'12.5',detail:'12.5 m² per workstation NIA'}
      ];
      function setDensity(val){
        const idx=DENSITIES.findIndex(d=>d.value===val);
        if(idx>=0){densitySlider.value=idx; updateDensity();}
      }

      function updateDensity(emit=true){
        const idx=parseInt(densitySlider.value,10);
        const d=DENSITIES[idx];
        densitySel.value=d.value;
        densityOutput.textContent=d.label;
        const pct=idx/(DENSITIES.length-1);
        densityOutput.style.left=`${pct*100}%`;
        if(idx===0) densityOutput.style.transform='translateX(0)';
        else if(idx===DENSITIES.length-1) densityOutput.style.transform='translateX(-100%)';
        else densityOutput.style.transform='translateX(-50%)';
        densityDots.forEach((dot,i)=>{dot.classList.toggle('active',i===idx);});
        if(emit) densitySel.dispatchEvent(new Event('change'));
      }
        DENSITIES.forEach((d,i)=>{
          const dot=document.createElement('div');
          dot.className='step-dot';
          dot.style.left=`${(i/(DENSITIES.length-1))*100}%`;
          densitySliderWrap.appendChild(dot);
          densityDots.push(dot);
        });
        function handleDensityHover(e){
          const rect=densitySliderWrap.getBoundingClientRect();
          const x=e.clientX-rect.left;
          const stepWidth=rect.width/(DENSITIES.length-1);
          const idx=Math.round(x/stepWidth);
          const stepX=idx*stepWidth;
          if(Math.abs(x-stepX)<stepWidth/4){
            densityDetail.textContent=DENSITIES[idx].detail;
            const pct=idx/(DENSITIES.length-1);
            const left=pct*rect.width;
            densityDetail.style.left=`${left}px`;
            if(idx===0) densityDetail.style.transform='translateX(0)';
            else if(idx===DENSITIES.length-1) densityDetail.style.transform='translateX(-100%)';
            else densityDetail.style.transform='translateX(-50%)';
            densityDetail.classList.remove('hidden');
            densityOutput.textContent=DENSITIES[idx].label;
            densityOutput.style.left=`${pct*100}%`;
            if(idx===0) densityOutput.style.transform='translateX(0)';
            else if(idx===DENSITIES.length-1) densityOutput.style.transform='translateX(-100%)';
            else densityOutput.style.transform='translateX(-50%)';
          }else{
            densityDetail.classList.add('hidden');
          }
        }
        densitySliderWrap.addEventListener('mousemove',handleDensityHover);
        densitySliderWrap.addEventListener('mouseleave',()=>{densityDetail.classList.add('hidden'); updateDensity(false);});
        densitySlider.addEventListener('input',()=>updateDensity());
      updateDensity();

        const hybridSel=$('hybridSelect');
        const hybridSlider=$('hybridSlider');
        const hybridOutput=$('hybridOutput');
        const hybridSliderWrap=$('hybridSliderWrap');
        const hybridDetail=$('hybridDetail');
        const hybridDots=[];
        // Exact mapping between staff-per-workstation ratio and desks-per-staff occupancy.
        // 1.666... is 5/3, matching the “3 days in office” (≈60%) intent precisely.
        const HYBRID_RATIOS = [1, 1.25, 1.6666666667, 2.5, 5];
        const HYBRID_OCC    = HYBRID_RATIOS.map(r => 1 / r); // 1.00, 0.80, 0.60, 0.40, 0.20
        const fmtRatio = (x)=> (Math.round(x*100)/100).toFixed(2);
        const HYBRID_BUFFER=1.1;
        const HYBRID_DETAILS=[
          'Suitable for an average of 5 days in office per week',
          'Suitable for an average of 4 days in office per week',
          'Suitable for an average of 3 days in office per week',
          'Suitable for an average of 2 days in office per week',
          'Suitable for an average of 1 day in office per week'
        ];
      function updateHybrid(emit=true){
        const idx=parseInt(hybridSlider.value,10);
        const r=HYBRID_RATIOS[idx];
        hybridSel.value=r;
        hybridSel.dataset.occ=HYBRID_OCC[idx];
        hybridOutput.textContent=`1:${fmtRatio(r)}`;
        const pct=idx/(HYBRID_RATIOS.length-1);
        hybridOutput.style.left=`${pct*100}%`;
        if(idx===0) hybridOutput.style.transform='translateX(0)';
        else if(idx===HYBRID_RATIOS.length-1) hybridOutput.style.transform='translateX(-100%)';
        else hybridOutput.style.transform='translateX(-50%)';
        hybridDots.forEach((dot,i)=>{dot.classList.toggle('active',i===idx);});
        if(emit) hybridSel.dispatchEvent(new Event('change'));
      }
        HYBRID_RATIOS.forEach((r,i)=>{
          const dot=document.createElement('div');
          dot.className='step-dot';
          dot.style.left=`${(i/(HYBRID_RATIOS.length-1))*100}%`;
          hybridSliderWrap.appendChild(dot);
          hybridDots.push(dot);
        });
        function handleHybridHover(e){
          const rect=hybridSliderWrap.getBoundingClientRect();
          const x=e.clientX-rect.left;
          const stepWidth=rect.width/(HYBRID_RATIOS.length-1);
          const idx=Math.round(x/stepWidth);
          const stepX=idx*stepWidth;
          if(Math.abs(x-stepX)<stepWidth/4){
            hybridDetail.textContent=HYBRID_DETAILS[idx];
            const pct=idx/(HYBRID_RATIOS.length-1);
            const left=pct*rect.width;
            hybridDetail.style.left=`${left}px`;
            if(idx<=1) hybridDetail.style.transform='translateX(0)';
            else if(idx>=HYBRID_RATIOS.length-2) hybridDetail.style.transform='translateX(-100%)';
            else hybridDetail.style.transform='translateX(-50%)';
            hybridDetail.classList.remove('hidden');
            hybridOutput.textContent=`1:${fmtRatio(HYBRID_RATIOS[idx])}`;
            hybridOutput.style.left=`${pct*100}%`;
            if(idx===0) hybridOutput.style.transform='translateX(0)';
            else if(idx===HYBRID_RATIOS.length-1) hybridOutput.style.transform='translateX(-100%)';
            else hybridOutput.style.transform='translateX(-50%)';
          }else{
            hybridDetail.classList.add('hidden');
          }
        }
        hybridSliderWrap.addEventListener('mousemove',handleHybridHover);
        hybridSliderWrap.addEventListener('mouseleave',()=>{hybridDetail.classList.add('hidden'); updateHybrid(false);});
        hybridSlider.addEventListener('input',()=>updateHybrid());
      updateHybrid();

      const modeGroup=$('modeBtns'); const ageGroup=$('ageBtns');
      const modeButtons=modeGroup.querySelectorAll('button');
      const ageButtons=ageGroup.querySelectorAll('button');
      let modeValue='';
      let ageValue='';
      let calcClicked=false;
      let contactsLoaded=false;
      const pplInp=$('peopleInput'); const budInp=$('budgetInput');
      const pplGrp=$('peopleGroup'); const budGrp=$('budgetGroup');
      const extrasSection=$('extrasSection');
      const customiseToggle=$('customiseToggle');
      const custArrow=customiseToggle.querySelector('svg');
      const extrasWrap=$('extrasWrap');
      const calcBtn=$('calcBtn');
      const calcBtnWrap=$('calcBtnWrap');
      const contactSection=$('contactSection');
      const contactsContainer=$('contactsContainer');
      const costPeriodSel=$('costPeriod');
      const budgetToggle=$('budgetToggle');
      const budgetLabel=$('budgetLabel');
      const areaR1=$('areaResult1'); const costR1=$('costResult1'); const pplR1=$('peopleResult1');
      const areaR2=$('areaResult2'); const costR2=$('costResult2'); const pplR2=$('peopleResult2');
      const resultContainer=$('resultContainer');
      const title1=$('resultTitle1'); const title2=$('resultTitle2'); const box2=$('resultBox2'); const resWrap=$('resultWrapper');
      const errs={mode:$('modeError'),location:$('locationError'),age:$('ageError'),people:$('peopleError'),budget:$('budgetError')};
      const calcWrap=$('calcWrapper'); const occWrap=$('occWrapper');
      const calcTab=$('calcTab'); const occTab=$('occTab');
      const occBars=$("occBars"); const occTables=$("occTables"); const occClear=$("occClear"); const occPrompt=$("occPrompt");
      const occFilterBtn=$('occFilterBtn'); const occFilterMenu=$('occFilterMenu');
      const filterNew=$('filterNew'); const filterOld=$('filterOld');
      const occLimitMsg=$('occLimitMsg');
      const occDownloadWrap=$('occDownloadWrap');
      const occUnits=$('occUnits');
      const downloadBtn=$('downloadBtn');
      const downloadMenu=$('downloadMenu');
      const downloadCsv=$('downloadCsv');
      const calcDownloadWrap=$('calcDownloadWrap');
      const calcDownloadBtn=$('calcDownloadBtn');
      const calcDownloadMenu=$('calcDownloadMenu');
      const calcDownloadCsv=$('calcDownloadCsv');
      const calcSection=$("calcSection");
      const hybridInfo=$('hybridInfo'); const hybridTooltip=$('hybridTooltip');
      let occData=[];
      let showNew=true, showOld=true;
      let budgetPeriod='annual';
      let annualBudgetRaw='', monthlyBudgetRaw='';
      function alignResultTitles(){
        title1.style.height='auto';
        title2.style.height='auto';
        if(!locSel2.value) return;
        const max=Math.max(title1.offsetHeight,title2.offsetHeight);
        title1.style.height=title2.style.height=max+'px';
      }
      updateFieldHighlight(locSel);
      updateFieldHighlight(locSel2);
      updateFieldHighlight(pplInp);
      updateFieldHighlight(budInp);

      hybridInfo.addEventListener('click',e=>{
        e.stopPropagation();
        hybridTooltip.classList.toggle('hidden');
      });
      hybridTooltip.addEventListener('click',e=>e.stopPropagation());
      document.addEventListener('click',()=>hybridTooltip.classList.add('hidden'));

      EXTRA_NAMES.forEach(name=>{
        const row=document.createElement('div');
        row.className='flex items-center justify-between mb-1';
        const label=document.createElement('span');
        label.textContent=name;
        const cb=document.createElement('input');
        cb.type='checkbox';
        cb.checked=true;
        cb.dataset.extra=name;
        cb.className='h-4 w-4';
        row.appendChild(label);
        row.appendChild(cb);
        extrasWrap.appendChild(row);
      });
      customiseToggle.addEventListener('click',()=>{
        extrasWrap.classList.toggle('hidden');
        customiseToggle.classList.toggle('active');
        custArrow.classList.toggle('rotate-180');
      });
      extrasWrap.addEventListener('change',e=>{
        if(e.target.matches('input[type="checkbox"]')){
          const n=e.target.dataset.extra;
          if(e.target.checked) activeExtras.add(n); else activeExtras.delete(n);
          if(!resWrap.classList.contains('hidden')) performCalc(); else autoCalcIfReady();
        }
      });
      // populate locations dropdown with London first then major cities
      const londonLocs=LOCS
        .filter(l=>l.region==='London' && !l.regionMarker)
        .sort((a,b)=>a.name.localeCompare(b.name));
      const mainLocs=LOCS
        .filter(l=>l.main && l.region!=='London')
        .sort((a,b)=>a.name.localeCompare(b.name));
      const otherLocs=LOCS
        .filter(l=>!l.regionMarker && l.region!=='London' && !l.main)
        .sort((a,b)=>a.name.localeCompare(b.name));
      [...londonLocs,...mainLocs,...otherLocs].forEach(loc=>{
        const opt=document.createElement('option');
        const clean=cleanName(loc.name);
        const displayName=breakLigatures(clean);
        opt.value=clean;
        opt.textContent=displayName;
        locSel.appendChild(opt);
        locSel2.appendChild(opt.cloneNode(true));
      });
      const addOptionsHTML = locSel.innerHTML;

      modeButtons.forEach(btn=>{
        btn.addEventListener('click',()=>{
          modeValue=btn.dataset.value;
          modeButtons.forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          toggleInputs();
        });
      });
      ageButtons.forEach(btn=>{
        btn.addEventListener('click',()=>{
          ageValue=btn.dataset.value;
          ageButtons.forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          if(!resWrap.classList.contains('hidden')) performCalc();
        });
      });

      function clearErr(){
        Object.values(errs).forEach(e=>e.style.display='none');
        [locSel,densitySel,pplInp,budInp].forEach(el=>el.classList.remove('error'));
        modeGroup.classList.remove('error');
        ageGroup.classList.remove('error');
      }
      function costPerSqm(loc){
        const data = COSTS[loc];
        const age  = AGE_MAP[ageValue];
        if(!data || !age || !data[age]) return 0;

        let psf = data[age].totalSqft; // £ per ft²
        const extras = EXTRAS_CLEAN[loc];
        if (extras){
          EXTRA_NAMES.forEach(n=>{
            if(!activeExtras.has(n)) psf -= (extras[n] || 0);
          });
        }
        psf = Math.max(0, psf);               // guard against negative totals
        return psf * SQM_TO_SQFT;             // £ per m²
      }

      async function loadContacts(){
        if(contactsLoaded) return;
        const res=await fetch('Office_staff_info.csv');
        const text=await res.text();
        const rows=text.trim().split('\n').slice(1).map(l=>l.split(','));
        const targets=['David Earle','Oliver Du Sautoy'];
        const imgMap={
          'David Earle':'Agent%20photos/David%20Earle.jpg',
          'Oliver Du Sautoy':'Agent%20photos/Oliver%20du%20Sautoy.jpg'
        };
        rows.filter(r=>targets.includes(r[0])).forEach(r=>{
          const [name,,mobile,email,status]=r;
          const card=document.createElement('div');
          card.className='bg-gray-50 p-6 rounded-lg shadow flex flex-col items-center text-center';
          const img=document.createElement('img');
          img.src=imgMap[name];
          img.alt=`Photo of ${name}`;
          img.className='mb-3 w-32 h-40 object-cover rounded-lg';
          if(name==='Oliver Du Sautoy') img.style.objectPosition='center 60%';
          card.appendChild(img);
          const nm=document.createElement('div');
          nm.className='font-din-bold mb-1 text-lg';
          nm.textContent=name;
          card.appendChild(nm);
          const st=document.createElement('div');
          st.className='text-sm text-gray-600 h-12 flex items-center justify-center mb-2';
          st.textContent=status;
          card.appendChild(st);
          const mob=document.createElement('div');
          mob.className='text-sm text-gray-600 mb-1';
          const mobLink=document.createElement('a');
          mobLink.href=`tel:${mobile.replace(/\s+/g,'')}`;
          mobLink.textContent=mobile;
          mobLink.className='hover:underline';
          mob.appendChild(mobLink);
          card.appendChild(mob);
          const em=document.createElement('div');
          em.className='text-sm text-gray-600';
          const emLink=document.createElement('a');
          emLink.href=`mailto:${email}`;
          emLink.textContent=email;
          emLink.className='text-lsh-red hover:underline';
          em.appendChild(emLink);
          card.appendChild(em);
          contactsContainer.appendChild(card);
        });
        contactsLoaded=true;
      }

      function showContacts(){
        loadContacts();
        contactSection.classList.remove('hidden');
        requestAnimationFrame(()=>{
          const heading=contactSection.querySelector('h3');
          if(heading && title1){
            const offset=title1.getBoundingClientRect().top-heading.getBoundingClientRect().top;
            const current=parseFloat(getComputedStyle(contactSection).marginTop)||0;
            contactSection.style.marginTop=`${current+offset}px`;
          }
        });
      }

      function hideContacts(){
        contactSection.classList.add('hidden');
        contactSection.style.marginTop='';
      }

      function toggleInputs(){
        const showPeople=modeValue==='people';
        const showBudget=modeValue==='budget';
        pplGrp.classList.toggle('hidden',!showPeople);
        budGrp.classList.toggle('hidden',!showBudget);
        extrasSection.classList.toggle('hidden',!(showPeople||showBudget));
        calcBtnWrap.classList.toggle('mt-3',!showPeople&&!showBudget);
        resWrap.classList.add('hidden');
        calcDownloadWrap.classList.add('hidden');
        hideContacts();
        costPeriodSel.classList.add('hidden');
        costPeriodSel.value='annual';
        if(!(showPeople||showBudget)){
          extrasWrap.classList.add('hidden');
          customiseToggle.classList.remove('active');
          custArrow.classList.remove('rotate-180');
        }
        if(showPeople) calcBtn.textContent='Calculate cost';
        else if(showBudget) calcBtn.textContent='Calculate capacity';
        else calcBtn.textContent='Calculate';
        if(!showBudget){
          budgetPeriod='annual';
          budgetLabel.textContent='Annual budget (£)';
          budgetToggle.textContent='Monthly budget (£)';
          budInp.value='';
          updateFieldHighlight(budInp);
        }
      }

      function updateComparePrompt(){
        comparePrompt.classList.toggle('hidden',!(locSel.value && !locSel2.value));
        removeLoc1.style.display = locSel.value ? 'block' : 'none';
        removeLoc2.style.display = locSel2.value ? 'block' : 'none';
        updateFieldHighlight(locSel);
        updateFieldHighlight(locSel2);
      }

      function autoCalcIfReady(){
        const ready =
          locSel.value && ageValue && modeValue &&
          ((modeValue==='people' && pplInp.value) ||
           (modeValue==='budget' && budInp.value));
        if(!resWrap.classList.contains('hidden')) performCalc();
        else if(ready) performCalc();
      }

      function updateCostPeriod(){
        const period=costPeriodSel.value;
        [costR1,costR2].forEach(el=>{
          const ac=el.dataset.annualCost?parseInt(el.dataset.annualCost,10):null;
          const pw=el.dataset.annualPerWs?parseInt(el.dataset.annualPerWs,10):null;
          if(ac===null||pw===null) return;
          const isAnnual=period==='annual';
          const cost=isAnnual?ac:Math.round(ac/12);
          const perWs=isAnnual?pw:Math.round(pw/12);
          const costLabel=isAnnual?'Annual cost':'Monthly cost';
          const wsLabel=isAnnual?'Total per workstation (annual)':'Total per workstation (monthly)';
          renderResult(el,costLabel,`£${cost.toLocaleString()}`);
          renderResult(el,wsLabel,`£${perWs.toLocaleString()}`,true,false,false,!!locSel2.value);
        });
        updateScrollbars();
      }

      function switchTab(tab){
        if(tab==='calc'){
          calcWrap.classList.remove('hidden');
          occWrap.classList.add('hidden');
          calcTab.classList.add('active');
          occTab.classList.remove('active');
          occPrompt.classList.add('hidden');
        }else{
          calcWrap.classList.add('hidden');
          calcTab.classList.remove('active');
          occTab.classList.add('active');
          updateOccUI();
        }
        // reset map to default view when switching tools
        regionToggle.querySelectorAll('button').forEach((b,i)=>{
          b.classList.toggle('active',i===0);
        });
        showMarkers('All UK');
        map.setView(REGIONS[0].center, REGIONS[0].zoom);
        if(choicePopup) { map.removeLayer(choicePopup); choicePopup=null; }
        highlightSelections(false);
      }
      calcTab.addEventListener('click',()=>switchTab('calc'));
      occTab.addEventListener('click',()=>switchTab('occ'));

      function updateOccUI(){
        occBars.innerHTML="";
        occTables.innerHTML="";
        occLimitMsg.classList.add('hidden');
        occPrompt.classList.add('hidden');
        occWrap.classList.remove('hidden');
        const hasData = occData.length > 0;
        occBars.classList.toggle('placeholder', !hasData);
        occDownloadWrap.classList.toggle('hidden', !hasData);
        occUnits.classList.toggle('hidden', !hasData);
        let max=0;
        if(hasData){
          max=Math.max(...occData.flatMap(d=>[
            d.new?.totalSqft||0,
            d.old?.totalSqft||0
          ]));
        }
        occData.forEach((d,idx)=>{
          const col=document.createElement("div");
          col.className="bar-col flex flex-col items-center justify-between p-2 border rounded h-56 relative";
          const rem=document.createElement('button');
          rem.className='remove-btn';
          rem.innerHTML='&times;';
          rem.addEventListener('click',()=>{occData.splice(idx,1);updateOccUI();});
          col.appendChild(rem);
          const label=document.createElement("div");
          label.className="text-sm font-din-bold mb-1 text-center h-10 flex items-center justify-center";
          label.textContent=d.name;
          const bars=document.createElement("div");
          bars.className="flex-1 flex items-end gap-2";
          const nb=document.createElement("div");
          nb.className="occ-bar-new text-white text-xs flex items-center justify-center w-16";
          nb.style.height="0px";
          nb.innerHTML=`<div class="bar-label">${d.new?`£${d.new.totalSqft.toFixed(2)}`:'N/A'}<br><small>psf</small></div>`;
          const ob=document.createElement("div");
          ob.className="occ-bar-old text-white text-xs flex items-center justify-center w-16";
          ob.style.height="0px";
          ob.innerHTML=`<div class="bar-label">${d.old?`£${d.old.totalSqft.toFixed(2)}`:'N/A'}<br><small>psf</small></div>`;
          bars.appendChild(nb); bars.appendChild(ob);
          const labs=document.createElement("div");
          labs.className="flex gap-2 mt-0.5";
          const labNew=document.createElement('span');
          labNew.className='bar-cat w-16';
          labNew.textContent='New build';
          const labOld=document.createElement('span');
          labOld.className='bar-cat w-16';
          labOld.textContent='20-yr old';
          labs.appendChild(labNew);
          labs.appendChild(labOld);
          col.appendChild(label); col.appendChild(bars); col.appendChild(labs);
          occBars.appendChild(col);
          const wrap=document.createElement('div');
          wrap.className='relative mb-4 result-scroll';
          const table=document.createElement("table");
          table.className="w-full text-sm border-collapse";
          const rem2=rem.cloneNode(true);
          rem2.classList.add('table-remove');
          rem2.addEventListener('click',()=>{occData.splice(idx,1);updateOccUI();});
          wrap.appendChild(rem2);
          const headers=['Total','Net effective rent','Business rates','Annualised costs','Hard FM','Soft FM','Management fees','Total per workstation'];
          const keys=['totalSqft','netEffectiveRent','rates','annualisedCosts','hardFM','softFM','managementFees','totalWorkstation'];
          const headRow='<tr class="bg-gray-50"><th class="border px-2 py-1 text-center">Building age</th>'+headers.map((h,i)=>`<th class="border px-2 py-1 text-center${i>=4?' extra-col':''}">${h}</th>`).join('')+'</tr>';
          function buildRow(label,obj){
            if(!obj) return '';
            return '<tr><td class="border px-2 py-1 text-center">'+label+'</td>'+keys.map((k,i)=>{
              const v=obj[k];
              return `<td class="border px-2 py-1 text-center${i>=4?' extra-col':''}">£${k==='totalWorkstation'?Math.round(v).toLocaleString():v.toFixed(2)}</td>`;
            }).join('')+'</tr>';
          }
          let rows='';
          if(showNew) rows+=buildRow('New build',d.new);
          if(showOld) rows+=buildRow('20‑yr old',d.old);
          table.innerHTML=`<thead><tr class="bg-gray-100"><th class="border px-2 py-1 text-center" colspan="${keys.length+1}">${d.name}</th></tr>${headRow}</thead><tbody>${rows}</tbody>`;
          wrap.appendChild(table);
          occTables.appendChild(wrap);
          function applyHeights(){
            nb.style.opacity=showNew?"1":"0";
            ob.style.opacity=showOld?"1":"0";
            labNew.style.opacity=showNew?"1":"0";
            labOld.style.opacity=showOld?"1":"0";
            nb.style.height=showNew&&d.new?(d.new.totalSqft/max*120)+"px":"0px";
            ob.style.height=showOld&&d.old?(d.old.totalSqft/max*120)+"px":"0px";
          }
          setTimeout(applyHeights,20);
        });
        for(let i=occData.length;i<3;i++){
          const col=document.createElement('div');
          col.className='bar-col placeholder-col flex flex-col items-center justify-center p-2 rounded h-56';
          const plus=document.createElement('div');
          plus.className='occ-placeholder mb-2';
          plus.textContent='+';
          const btn=document.createElement('button');
          btn.className='bg-lsh-red hover:bg-lsh-red-dark text-white px-2 py-1 rounded font-din-bold mb-2';
          btn.textContent='Add location';
          const wrap=document.createElement('div');
          wrap.className='mt-2 hidden';
          const sel=document.createElement('select');
          sel.className='border rounded p-2 bg-white';
          sel.innerHTML=addOptionsHTML;
          wrap.appendChild(sel);
          btn.addEventListener('click',()=>{wrap.classList.toggle('hidden');});
          sel.addEventListener('change',()=>{
            const val=sel.value;
            if(!val) return;
            if(occData.length>=3){
              occLimitMsg.classList.remove('hidden');
              return;
            }
            occLimitMsg.classList.add('hidden');
            const cost=COSTS[val]||{};
            occData.push({name:val,new:cost.new||null,old:cost.old||null});
            updateOccUI();
          });
          col.appendChild(plus);
          col.appendChild(btn);
          col.appendChild(wrap);
          occBars.appendChild(col);
        }
        if(hasData){
        }
        updateScrollbars();
      }

      occFilterBtn.addEventListener('click',e=>{
        e.stopPropagation();
        occFilterMenu.classList.toggle('hidden');
      });
      occFilterMenu.addEventListener('click',e=>e.stopPropagation());
      filterNew.addEventListener('change',()=>{showNew=filterNew.checked; updateOccUI();});
      filterOld.addEventListener('change',()=>{showOld=filterOld.checked; updateOccUI();});

      occClear.addEventListener('click',()=>{occData=[]; document.getElementById('occLimitMsg').classList.add('hidden'); updateOccUI();});
      calcClear.addEventListener('click',()=>{
        modeValue=''; ageValue='';
        [locSel,locSel2,pplInp,budInp].forEach(el=>{el.value=''; updateFieldHighlight(el);});
        setDensity('10');
        modeButtons.forEach(b=>b.classList.remove('active'));
        ageButtons.forEach(b=>b.classList.remove('active'));
        loc2Wrap.classList.add('hidden');
        resWrap.classList.add('hidden');
        calcDownloadWrap.classList.add('hidden');
        hideContacts();
        calcClicked=false;
        resetMarkers();
        updateComparePrompt();
        toggleInputs();
        highlightSelections(false);
        extrasWrap.classList.add('hidden');
        customiseToggle.classList.remove('active');
        custArrow.classList.remove('rotate-180');
        activeExtras.clear();
        EXTRA_NAMES.forEach(x=>activeExtras.add(x));
        extrasWrap.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.checked=true);
      });
      removeLoc2.addEventListener('click',()=>{
        locSel2.value='';
        loc2Wrap.classList.add('hidden');
        highlightSelections();
        updateComparePrompt();
        autoCalcIfReady();
      });
      removeLoc1.addEventListener('click',()=>{
        if(locSel2.value){
          locSel.value=locSel2.value;
          locSel2.value='';
          loc2Wrap.classList.add('hidden');
        }else{
          locSel.value='';
        }
        highlightSelections();
        updateComparePrompt();
        autoCalcIfReady();
      });

      function buildCSV(){
        const headers=['Building age','Total','Net effective rent','Business rates','Annualised costs','Hard FM','Soft FM','Management fees','Total per workstation'];
        const lines=['Lambert Smith Hampton'];
        function row(label,obj){
          return [
            label,
            `£${obj.totalSqft.toFixed(2)}`,
            `£${obj.netEffectiveRent.toFixed(2)}`,
            `£${obj.rates.toFixed(2)}`,
            `£${obj.annualisedCosts.toFixed(2)}`,
            `£${obj.hardFM.toFixed(2)}`,
            `£${obj.softFM.toFixed(2)}`,
            `£${obj.managementFees.toFixed(2)}`,
            `"£${Math.round(obj.totalWorkstation).toLocaleString()}"`
          ].join(',');
        }
        lines.push('');
        occData.forEach(d=>{
          lines.push(d.name);
          lines.push(headers.join(','));
          if(showNew) lines.push(row('New build',d.new));
          if(showOld) lines.push(row('20-yr old',d.old));
          lines.push('');
        });
        lines.push('Property of Lambert Smith Hampton');
        return lines.join('\r\n');
      }

      function triggerDownload(csv,filename){
        const blob=new Blob([csv],{type:'text/csv'});
        const link=document.createElement('a');
        link.href=URL.createObjectURL(blob);
        link.download=filename;
        document.body.appendChild(link);
        link.click();
        setTimeout(()=>{URL.revokeObjectURL(link.href); document.body.removeChild(link);},0);
      }

      function downloadFile(){
        const csv='\uFEFF'+buildCSV();
        triggerDownload(csv,'occupancy-costs.csv');
      }

      function buildCalcCSV(){
        const usePeople=modeValue==='people';
        const costPeriod=costPeriodSel.value||'annual';
        const costHeaders=costPeriod==='annual'?['Annual cost (\u00A3)','Total per workstation (annual \u00A3)']:["Monthly cost (\u00A3)","Total per workstation (monthly \u00A3)"];
        const metricHeaders=usePeople?
          ['Space required (m\u00B2)','Space required (ft\u00B2)',...costHeaders]:
          ['Area achievable (m\u00B2)','Area achievable (ft\u00B2)','Workstations accommodated','Staff accommodated'];
        const budgetLabel=budgetPeriod==='monthly'?'Monthly budget (\u00A3)':'Annual budget (\u00A3)';
        const header=['Location','Building age',usePeople?'Staff':budgetLabel,'Workstation density (m\u00B2 per workstation NIA)','Hybrid working factor (staff per workstation)',...metricHeaders];
        const ageLabel=ageValue==='New'? 'New build':'20-yr old';
        const densityLabel=densitySel.value;
        const hybridLabel='1:'+hybridSel.value;
        const lines=['Lambert Smith Hampton', '', header.join(',')];
        const sqmPerPerson=parseFloat(densityLabel || DEFAULT_SQM_PER_PERSON);
        const n=usePeople?parseInt(pplInp.value,10):0;
        const staffPerWS=parseFloat(hybridSel.value || '1');
        const occupancy=parseFloat(hybridSel.dataset.occ || '1');
        const buffer = hybridSel.value==='1'?1:HYBRID_BUFFER;
        const inputBudget=!usePeople?parseInt(budInp.value.replace(/,/g,''),10):0;
        const budget=!usePeople?(budgetPeriod==='monthly'?(annualBudgetRaw?parseInt(annualBudgetRaw,10):inputBudget*12):inputBudget):0;
        function q(str){return `"${String(str).replace(/"/g,'""')}"`;}
        function addRow(loc){
          const cpsqm=costPerSqm(loc);
          if(usePeople){
            const staff=n;
            const workstations=Math.ceil(staff*occupancy*buffer);
            const sqm=workstations*sqmPerPerson;
            const sqft=sqm*SQM_TO_SQFT;
            const cost=Math.round(sqm*cpsqm);
            const perWS=Math.round(cpsqm*sqmPerPerson);
            const outCost=costPeriod==='annual'?cost:Math.round(cost/12);
            const outPerWs=costPeriod==='annual'?perWS:Math.round(perWS/12);
            lines.push([
              q(loc),
              ageLabel,
              staff,
              densityLabel,
              hybridLabel,
              Math.round(sqm),
              Math.round(sqft),
              outCost,
              outPerWs
            ].join(','));
          }else{
            const sqm=budget/cpsqm;
            const sqft=sqm*SQM_TO_SQFT;
            const workstations=Math.floor(sqm/sqmPerPerson);
            const staff=Math.floor((workstations/ buffer)*staffPerWS);
            lines.push([
              q(loc),
              ageLabel,
              q(budInp.value),
              densityLabel,
              hybridLabel,
              Math.round(sqm),
              Math.round(sqft),
              workstations,
              staff
            ].join(','));
          }
        }
        addRow(locSel.value);
        if(locSel2.value) addRow(locSel2.value);
        lines.push('Property of Lambert Smith Hampton');
        return lines.join('\r\n');
      }

      function downloadCalcFile(){
        const csv='\uFEFF'+buildCalcCSV();
        triggerDownload(csv,'space-calculator.csv');
      }

      if(ENABLE_DOWNLOADS){
        downloadBtn.addEventListener('click',e=>{
          e.stopPropagation();
          downloadMenu.classList.toggle('hidden');
        });
        downloadMenu.addEventListener('click',e=>e.stopPropagation());
        downloadCsv.addEventListener('click',e=>{e.preventDefault(); downloadFile(); downloadMenu.classList.add('hidden');});

        calcDownloadBtn.addEventListener('click',e=>{e.stopPropagation(); calcDownloadMenu.classList.toggle('hidden');});
        calcDownloadMenu.addEventListener('click',e=>e.stopPropagation());
        calcDownloadCsv.addEventListener('click',e=>{e.preventDefault(); downloadCalcFile(); calcDownloadMenu.classList.add('hidden');});
      } else {
        occDownloadWrap.style.display='none';
        calcDownloadWrap.style.display='none';
      }

      document.addEventListener('click',()=>{
        occFilterMenu.classList.add('hidden');
        if(ENABLE_DOWNLOADS){
          downloadMenu.classList.add('hidden');
          calcDownloadMenu.classList.add('hidden');
        }
      });

      // auto‑comma budget and store raw values
      budInp.addEventListener('input',()=>{
        const raw=budInp.value.replace(/[^0-9]/g,'');
        budInp.value=raw?parseInt(raw,10).toLocaleString():'';
        if(modeValue==='budget'){
          if(budgetPeriod==='annual'){
            annualBudgetRaw=raw;
            monthlyBudgetRaw=raw?Math.round(parseInt(raw,10)/12).toString():'';
          }else{
            monthlyBudgetRaw=raw;
            annualBudgetRaw=raw?(parseInt(raw,10)*12).toString():'';
          }
        }
        updateFieldHighlight(budInp);
        if(!budGrp.classList.contains('hidden') && !resWrap.classList.contains('hidden')) performCalc();
      });

      budgetToggle.addEventListener('click',()=>{
        const wasAnnual=budgetPeriod==='annual';
        budgetPeriod=wasAnnual?'monthly':'annual';
        budgetLabel.textContent=budgetPeriod==='annual'?'Annual budget (£)':'Monthly budget (£)';
        budgetToggle.textContent=budgetPeriod==='annual'?'Monthly budget (£)':'Annual budget (£)';
        if(modeValue==='budget'){
          if(wasAnnual){
            if(annualBudgetRaw){
              const converted=Math.round(parseInt(annualBudgetRaw,10)/12);
              monthlyBudgetRaw=String(converted);
              budInp.value=converted.toLocaleString();
            }else{
              budInp.value='';
            }
          }else{
            if(annualBudgetRaw){
              budInp.value=parseInt(annualBudgetRaw,10).toLocaleString();
            }else if(monthlyBudgetRaw){
              const converted=parseInt(monthlyBudgetRaw,10)*12;
              annualBudgetRaw=String(converted);
              budInp.value=converted.toLocaleString();
            }else{
              budInp.value='';
            }
          }
          updateFieldHighlight(budInp);
          if(budInp.value && !resWrap.classList.contains('hidden')) performCalc();
          else{resWrap.classList.add('hidden'); calcDownloadWrap.classList.add('hidden'); hideContacts();}
        }else{
          budInp.value='';
          updateFieldHighlight(budInp);
          resWrap.classList.add('hidden');
          calcDownloadWrap.classList.add('hidden');
          hideContacts();
        }
      });

      pplInp.addEventListener('input',()=>{
        updateFieldHighlight(pplInp);
        if(!pplGrp.classList.contains('hidden') && !resWrap.classList.contains('hidden')) performCalc();
      });

      function performCalc(){
        clearErr(); let bad=false;
        if(!modeValue){errs.mode.style.display='block'; modeGroup.classList.add('error'); bad=true; }
        if(!locSel.value){errs.location.style.display='block'; locSel.classList.add('error'); bad=true; }
        if(!ageValue){errs.age.style.display='block'; ageGroup.classList.add('error'); bad=true; }

        const usePeople=modeValue==='people';
        let n,budget; const sqmPerPerson=parseFloat(densitySel.value || DEFAULT_SQM_PER_PERSON);
        const occupancy=parseFloat(hybridSel.dataset.occ || 1);
        const buffer = hybridSel.value==='1'?1:HYBRID_BUFFER;
        if(usePeople){
          n=parseInt(pplInp.value,10);
          if(!n||n<=0||n>2000){
            errs.people.textContent='Enter a number from 1 to 2,000';
            errs.people.style.display='block';
            pplInp.classList.add('error');
            bad=true;
          }
        }else if(modeValue==='budget'){
          budget=parseInt(budInp.value.replace(/,/g,''),10);
          if(!budget||budget<=0){
            errs.budget.textContent='Enter a budget > 0';
            errs.budget.style.display='block';
            budInp.classList.add('error');
            bad=true;
          }else if(budgetPeriod==='annual' && budget>MAX_ANNUAL_BUDGET){
            errs.budget.textContent = `Maximum annual budget is ${MAX_ANNUAL_BUDGET.toLocaleString()}`;
            errs.budget.style.display='block';
            budInp.classList.add('error');
            bad=true;
          }else if(budgetPeriod==='monthly' && budget>MAX_MONTHLY_BUDGET){
            errs.budget.textContent = `Maximum monthly budget is ${MAX_MONTHLY_BUDGET.toLocaleString()}`;
            errs.budget.style.display='block';
            budInp.classList.add('error');
            bad=true;
          }
          if(!bad && budgetPeriod==='monthly'){
            budget = annualBudgetRaw ? parseInt(annualBudgetRaw,10) : budget*12;
          }
        }
        if(bad) return;
       function calcLoc(loc,areaEl,costEl,pplEl,titleEl){
         const cpsqm=costPerSqm(loc);
         titleEl.textContent=loc;
         adjustTitle(titleEl);
          if(usePeople){
            const staff=n;
            const workstations=Math.ceil(staff*occupancy*buffer);
            const sqm=workstations*sqmPerPerson;
            const sqft=Math.round(sqm*SQM_TO_SQFT);
            areaEl.innerHTML='';
            renderResult(areaEl,'Space required',`${sqft.toLocaleString()} sq ft`,false,false,true);
            renderResult(areaEl,'Workstations required',`${workstations.toLocaleString()}`,true,false,true);
            pplEl.innerHTML='';
            pplEl.classList.add('hidden');
            const totalCost=Math.round(sqm*cpsqm);
            const perWS=Math.round(cpsqm*sqmPerPerson);
            costEl.dataset.annualCost=totalCost;
            costEl.dataset.annualPerWs=perWS;
            costEl.innerHTML='';
          } else {
            // Reuse already-computed cost/m²; still guard against zero.
            areaEl.innerHTML='';
            pplEl.innerHTML='';
            costEl.innerHTML='';
            delete costEl.dataset.annualCost;
            delete costEl.dataset.annualPerWs;

            if (cpsqm <= 0) {
              renderResult(areaEl,'Area achievable','0 sq ft',false,false,true);
              renderResult(areaEl,'Workstations accommodated','0',true,false,true);
              renderResult(pplEl,'Staff accommodated','0');
              pplEl.classList.remove('hidden');
              return;
            }

            const sqm  = budget / cpsqm;
            const sqft = Math.round(sqm * SQM_TO_SQFT);
            const workstations = Math.floor(sqm / sqmPerPerson);

            // Labels for budget mode
            renderResult(areaEl,'Area achievable',`${sqft.toLocaleString()} sq ft`,false,false,true);
            renderResult(areaEl,'Workstations accommodated',`${workstations.toLocaleString()}`,true,false,true);

            let staff = 0;
            if (workstations > 0) {
              const occ = parseFloat(hybridSel.dataset.occ || '1'); // desks per staff
              const buffer = hybridSel.value==='1' ? 1 : HYBRID_BUFFER;
              staff = Math.floor((workstations / buffer) / occ);
              renderResult(pplEl,'Staff accommodated',`${staff.toLocaleString()}`);

              const perWSAnnual = Math.round(budget / workstations);
              const perWS = budgetPeriod==='monthly' ? Math.round(perWSAnnual/12) : perWSAnnual;
              const wsLabel = budgetPeriod==='monthly' ? 'Total per workstation (monthly)' : 'Total per workstation (annual)';
              renderResult(pplEl, wsLabel, `£${perWS.toLocaleString()}`, true, false, false, !!locSel2.value);
            } else {
              renderResult(pplEl,'Staff accommodated','0');
            }

            pplEl.classList.remove('hidden');
          }
        }
       calcLoc(locSel.value,areaR1,costR1,pplR1,title1);
         if(locSel2.value){
           calcLoc(locSel2.value,areaR2,costR2,pplR2,title2);
           box2.classList.remove('hidden');
           resultContainer.classList.add('compare');
           resultContainer.classList.remove('single');
         }else{
           box2.classList.add('hidden');
           resultContainer.classList.add('single');
           resultContainer.classList.remove('compare');
         }
        costPeriodSel.classList.toggle('hidden',!usePeople);
        if(usePeople) updateCostPeriod();
        resWrap.classList.remove('hidden');
        resWrap.classList.remove('fade-in'); void resWrap.offsetWidth; resWrap.classList.add('fade-in');
        calcDownloadWrap.classList.remove('hidden');
        if(calcClicked) showContacts(); else hideContacts();
        updateComparePrompt();
        alignResultTitles();
        updateScrollbars();
        setTimeout(()=>{alignResultTitles(); updateScrollbars();},50);
      }

      calcBtn.addEventListener('click',()=>{calcClicked=true; performCalc();});
      densitySel.addEventListener('change',()=>{if(!resWrap.classList.contains('hidden')) performCalc(); else autoCalcIfReady();});
      hybridSel.addEventListener('change',()=>{if(!resWrap.classList.contains('hidden')) performCalc(); else autoCalcIfReady();});
      costPeriodSel.addEventListener('change',updateCostPeriod);

      toggleInputs(); // initialise visibility
      updateComparePrompt();

      // Map ------------------------------------------------------------------
      if(typeof L!=='undefined'){
        map=L.map('map',{zoomControl:false,attributionControl:false,preferCanvas:true}).setView(REGIONS[0].center,REGIONS[0].zoom);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png',{subdomains:'abcd',attribution:'&copy; OpenStreetMap & CartoDB'}).addTo(map);

        function tooltipDir(latlng){
          const p=map.latLngToContainerPoint(latlng);
          const size=map.getSize();
          if(p.x<80) return "right";
          if(size.x-p.x<80) return "left";
          if(p.y<40||size.y-p.y<40) return "right";
          return "top";
        }
        function comparePopupConfig(latlng){
          const ttDir=tooltipDir(latlng);
          const p=map.latLngToContainerPoint(latlng);
          const size=map.getSize();
          if(ttDir==='top'){
            if(size.y-p.y>80) return {dir:'bottom',offset:[0,8]};
            return {dir:p.x>size.x/2?'left':'right',offset:[p.x>size.x/2?-8:8,0]};
          }else{ // tooltip to the right
            if(p.x>120) return {dir:'left',offset:[-8,0]};
            return {dir:(size.y-p.y>80?'bottom':'top'),offset:[0,(size.y-p.y>80?8:-8)]};
          }
        }
        function ensurePopupVisible(latlng){
          const p=map.latLngToContainerPoint(latlng);
          const size=map.getSize();
          const padX=100, padY=60;
          let dx=0, dy=0;
          if(p.x<padX) dx=padX-p.x;
          else if(size.x-p.x<padX) dx=-(padX-(size.x-p.x));
          if(p.y<padY) dy=padY-p.y;
          else if(size.y-p.y<padY) dy=-(padY-(size.y-p.y));
          if(dx||dy) map.panBy([dx,dy],{animate:false});
        }
        regionToggle=$('regionToggle');
        REGIONS.forEach(({name,center,zoom},i)=>{
          const btn=document.createElement('button');
          btn.textContent=name;
          btn.className='region-btn'+(i===0?' active':'');
          btn.addEventListener('click',()=>{
            regionToggle.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
            btn.classList.add('active');
            showMarkers(name);
            const r=REGIONS.find(r=>r.name===name);
            if(r) map.setView(r.center,r.zoom);
            highlightSelections(false);
          });
          regionToggle.appendChild(btn);
        });

        const markers={};
        choicePopup=null;
        function updateMarkerSize(){
          const z=map.getZoom();
          // enlarge markers on the whole‑UK view for consistency with regional zoom levels
          const r=z<6?6:(z<9?6:8);
          Object.values(markers).forEach(m=>m.setRadius(r));
        }
        map.on('zoom',updateMarkerSize);
        function resetMarkers(){Object.values(markers).forEach(m=>m.setStyle({stroke:false,color:LSH_RED,fillColor:LSH_RED}));}
       highlightSelections=function(showTips=true){
          const activeBtn = regionToggle.querySelector('button.active');
          const region = activeBtn ? activeBtn.textContent : 'All UK';
          showMarkers(region);
          const loc1=LOCS.find(l=>l.name===locSel.value);
          const loc2=LOCS.find(l=>l.name===locSel2.value);
          if(loc1&&loc2&&loc1.region==='London'&&loc2.region==='London'){
            const lm=markers['London'];
            if(lm&&map.hasLayer(lm)) map.removeLayer(lm);
          }
          // close any previously opened tooltips
          Object.values(markers).forEach(m=>m.closeTooltip());
          const coords=[];
          const activeMarkers=[];
          [locSel.value,locSel2.value].forEach(n=>{
            if(n){
              const m=markers[n];
              if(m){
                if(!map.hasLayer(m)) m.addTo(map);
                m.setStyle({stroke:false,color:LSH_RED_DARK,fillColor:LSH_RED_DARK});
                activeMarkers.push(m);
                coords.push(m.getLatLng());
              }
            }
          });

          function openTips(){
            activeMarkers.forEach(m=>{
              const tt=m.getTooltip();
              tt.options.direction=tooltipDir(m.getLatLng());
              tt.update();
              m.openTooltip();
            });
          }

          if(showTips){
            if(coords.length===1){
              map.once('moveend',openTips);
              map.setView(coords[0], map.getZoom());
              setTimeout(openTips,0);
            }else if(coords.length===2){
              map.once('moveend',openTips);
              const bounds=L.latLngBounds(coords);
              let zoom=map.getBoundsZoom(bounds,false,[120,120]);
              const dist=coords[0].distanceTo(coords[1]);
              if(dist<500) zoom=Math.max(zoom,16);
              else if(dist<1000) zoom=Math.max(zoom,15);
              else if(dist<2000) zoom=Math.max(zoom,14);
              map.setView(bounds.getCenter(),zoom);
              setTimeout(openTips,0);
            }else{
              openTips();
            }
          }
        }
        LOCS.forEach(loc=>{
          const marker=L.circleMarker(loc.coords,{radius:6,stroke:false,color:LSH_RED,fillColor:LSH_RED,fillOpacity:0.9});
          const cost=COSTS[loc.name];
          if(cost){
            let tip = `<div class="text-xs"><div class="tooltip-name font-din-bold text-sm mb-1 text-center">${loc.name}</div>`;
            if(cost.new) tip += `<div class="font-semibold">New build: <span class="font-light">£${cost.new.totalSqft.toFixed(2)} psf</span></div>`;
            if(cost.old) tip += `<div class="font-semibold">20‑yr old: <span class="font-light">£${cost.old.totalSqft.toFixed(2)} psf</span></div>`;
            tip += '</div>';
            marker.bindTooltip(tip,{direction:'top',offset:[0,-8]});
          }else{
            marker.bindTooltip(`<div class="tooltip-name font-din-bold text-sm text-center">${loc.name}</div>`,{direction:'top',offset:[0,-8]});
          }
          marker.on('mouseover',function(){
            const tt=this.getTooltip();
            tt.options.direction=tooltipDir(this.getLatLng());
            tt.update();
            this.openTooltip();
          });
          marker.on('mouseout',function(){this.closeTooltip();});
          marker.on('click',()=>{
            if(loc.regionMarker){
              const region=REGIONS.find(r=>r.name===loc.region);
              if(region){
                regionToggle.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
                const btn=Array.from(regionToggle.children).find(b=>b.textContent===region.name);
                if(btn) btn.classList.add('active');
                showMarkers(region.name);
                map.setView(region.center,region.zoom);
              }
              return;
            }
            resetMarkers();
            marker.setStyle({stroke:false,color:LSH_RED_DARK,fillColor:LSH_RED_DARK});
            {
              const tt=marker.getTooltip();
              tt.options.direction=tooltipDir(marker.getLatLng());
              tt.update();
              marker.openTooltip();
            }
            if(calcTab.classList.contains('active')){
              if(!locSel.value){
                locSel.value=loc.name;
                loc2Wrap.classList.remove('hidden');
                updateComparePrompt();
                autoCalcIfReady();
              }else if(locSel.value!==loc.name && !locSel2.value){
                if(choicePopup) map.removeLayer(choicePopup);
                const cfg=comparePopupConfig(marker.getLatLng());
                ensurePopupVisible(marker.getLatLng());
                choicePopup=L.tooltip({direction:cfg.dir,interactive:true,className:'compare-popup',opacity:1,offset:cfg.offset})
                  .setLatLng(loc.coords)
                  .setContent(`<div class="compare-popup flex gap-2"><button class="btn btn-red" id="calcCmpBtn">Compare</button><button class="btn btn-gray" id="calcRepBtn">Replace</button></div>`)
                  .addTo(map);
                setTimeout(()=>{
                  document.getElementById('calcCmpBtn').addEventListener('click',()=>{
                    map.removeLayer(choicePopup); choicePopup=null;
                locSel2.value=loc.name;
                loc2Wrap.classList.remove('hidden');
                autoCalcIfReady();
                updateComparePrompt();
                highlightSelections();
              });
              document.getElementById('calcRepBtn').addEventListener('click',()=>{
                map.removeLayer(choicePopup); choicePopup=null;
                locSel.value=loc.name;
                loc2Wrap.classList.remove('hidden');
                autoCalcIfReady();
                updateComparePrompt();
                highlightSelections();
              });
                },0);
              }else if(locSel.value!==loc.name){
                if(choicePopup) map.removeLayer(choicePopup);
                const cfg=comparePopupConfig(marker.getLatLng());
                ensurePopupVisible(marker.getLatLng());
                const content = locSel2.value
                  ? `<div class="compare-popup flex flex-col gap-1"><button class="btn btn-gray" id="repLoc1Btn">Replace location 1</button><button class="btn btn-gray" id="repLoc2Btn">Replace location 2</button></div>`
                  : `<div class="compare-popup"><button class="btn btn-gray" id="calcRepBtn">Replace</button></div>`;
                choicePopup=L.tooltip({direction:cfg.dir,interactive:true,className:'compare-popup',opacity:1,offset:cfg.offset})
                  .setLatLng(loc.coords)
                  .setContent(content)
                  .addTo(map);
                setTimeout(()=>{
                  if(locSel2.value){
                    document.getElementById('repLoc1Btn').addEventListener('click',()=>{
                      map.removeLayer(choicePopup); choicePopup=null;
                      locSel.value=loc.name;
                      loc2Wrap.classList.remove('hidden');
                      autoCalcIfReady();
                      updateComparePrompt();
                      highlightSelections();
                    });
                    document.getElementById('repLoc2Btn').addEventListener('click',()=>{
                      map.removeLayer(choicePopup); choicePopup=null;
                      locSel2.value=loc.name;
                      loc2Wrap.classList.remove('hidden');
                      autoCalcIfReady();
                      updateComparePrompt();
                      highlightSelections();
                    });
                  }else{
                    document.getElementById('calcRepBtn').addEventListener('click',()=>{
                      map.removeLayer(choicePopup); choicePopup=null;
                      locSel2.value=loc.name;
                      loc2Wrap.classList.remove('hidden');
                      autoCalcIfReady();
                      updateComparePrompt();
                      highlightSelections();
                    });
                  }
                },0);
            }else{
              locSel.value=loc.name;
              autoCalcIfReady();
              updateComparePrompt();
              highlightSelections();
            }
            } else if(occTab.classList.contains('active')){
              const cost=COSTS[loc.name]||{};
              const newCost=cost.new||null;
              const oldCost=cost.old||null;
              if(choicePopup) map.removeLayer(choicePopup);
              if(occData.length>0){
                let content;
                if(occData.length>=3){
                  const btns = occData.map((_,i)=>`<button class="btn btn-gray repOpt" data-idx="${i}">Replace location ${i+1}</button>`).join('');
                  content = `<div class="compare-popup flex flex-col gap-1">${btns}</div>`;
                }else{
                  content = `<div class="compare-popup flex gap-2"><button class="btn btn-red" id="cmpBtn">Compare</button><button class="btn btn-gray" id="repBtn">Replace</button></div>`;
                }
                const cfg=comparePopupConfig(marker.getLatLng());
                ensurePopupVisible(marker.getLatLng());
                choicePopup=L.tooltip({direction:cfg.dir,interactive:true,className:'compare-popup',opacity:1,offset:cfg.offset})
                  .setLatLng(loc.coords)
                  .setContent(content)
                  .addTo(map);
                setTimeout(()=>{
                  const cmp=document.getElementById('cmpBtn');
                  if(cmp){
                    cmp.addEventListener('click',()=>{
                      map.removeLayer(choicePopup); choicePopup=null;
                      document.getElementById('occLimitMsg').classList.add('hidden');
                      occData.push({name:loc.name,new:newCost,old:oldCost});
                      updateOccUI();
                    });
                  }
                  const rep=document.getElementById('repBtn');
                  if(rep){
                    rep.addEventListener('click',()=>{
                      map.removeLayer(choicePopup); choicePopup=null;
                      document.getElementById('occLimitMsg').classList.add('hidden');
                      occData[occData.length-1]={name:loc.name,new:newCost,old:oldCost};
                      updateOccUI();
                    });
                  }
                  document.querySelectorAll('.repOpt').forEach(btn=>{
                    btn.addEventListener('click',()=>{
                      const idx=+btn.dataset.idx;
                      map.removeLayer(choicePopup); choicePopup=null;
                      document.getElementById('occLimitMsg').classList.add('hidden');
                      occData[idx]={name:loc.name,new:newCost,old:oldCost};
                      updateOccUI();
                    });
                  });
                },0);
              }else{
                document.getElementById('occLimitMsg').classList.add('hidden');
                occData=[{name:loc.name,new:newCost,old:oldCost}];
                updateOccUI();
              }
            }
          });
          markers[loc.name]=marker;
        });

        showMarkers=function(region,all=false){
          Object.values(markers).forEach(m=>{ if(map.hasLayer(m)) m.remove(); });
          const coords=[];
          LOCS.forEach(loc=>{
            if(region==='All UK'){
              if(all || loc.main){ markers[loc.name].addTo(map); coords.push(loc.coords); }
            }else if(loc.region===region){
              if(loc.name==='London') return;
              markers[loc.name].addTo(map);
              coords.push(loc.coords);
            }
          });
          resetMarkers();
          updateMarkerSize();
          return coords.length? L.latLngBounds(coords): null;
        }

        showMarkers('All UK');
        highlightSelections(false);
        updateMarkerSize();
        switchTab('occ');

        [locSel,locSel2].forEach(sel=>{
          sel.addEventListener('focus',()=>{
            sel.classList.remove('bg-lsh-red','text-white');
            sel.classList.add('bg-white');
          });
          sel.addEventListener('blur',()=>updateFieldHighlight(sel));
        });

        // respond to location dropdown changes
        locSel.addEventListener('change',()=>{
          updateFieldHighlight(locSel);
          const selected=LOCS.find(l=>l.name===locSel.value);
          if(!selected) return;
          const region=REGIONS.find(r=>r.name===selected.region);
          loc2Wrap.classList.remove('hidden');
          if(region && locSel2.value){
            regionToggle.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
            const btn=Array.from(regionToggle.children).find(b=>b.textContent===region.name);
            if(btn) btn.classList.add('active');
            showMarkers(region.name);
            map.setView(region.center,region.zoom);
          }
          resetMarkers();
          highlightSelections();
          autoCalcIfReady();
          updateComparePrompt();
        });

        locSel2.addEventListener('change',()=>{
          updateFieldHighlight(locSel2);
          const selected=LOCS.find(l=>l.name===locSel2.value);
          if(!selected) return;
          loc2Wrap.classList.remove('hidden');
          regionToggle.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
          showMarkers('All UK');
          resetMarkers();
          highlightSelections();
          autoCalcIfReady();
          updateComparePrompt();
        });

        window.addEventListener('load',()=>{
          setTimeout(()=>map.invalidateSize(),0);
          updateScrollbars();
        });
        window.addEventListener('resize',updateScrollbars);

      }
    })();
  </script>
</body>
</html>


